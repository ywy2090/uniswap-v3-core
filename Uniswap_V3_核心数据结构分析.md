# Uniswap V3 æ ¸å¿ƒæ•°æ®ç»“æ„æ·±åº¦åˆ†æ

## ğŸ“‹ ç›®å½•

1. [æ•°æ®ç»“æ„æ¦‚è§ˆ](#æ•°æ®ç»“æ„æ¦‚è§ˆ)
2. [Slot0 - ä¸»è¦çŠ¶æ€](#slot0---ä¸»è¦çŠ¶æ€)
3. [Position.Info - å¤´å¯¸ä¿¡æ¯](#positioninfo---å¤´å¯¸ä¿¡æ¯)
4. [Tick.Info - Tick ä¿¡æ¯](#tickinfo---tick-ä¿¡æ¯)
5. [Oracle.Observation - é¢„è¨€æœºè§‚å¯Ÿ](#oracleobservation---é¢„è¨€æœºè§‚å¯Ÿ)
6. [å…¶ä»–é‡è¦ç»“æ„](#å…¶ä»–é‡è¦ç»“æ„)
7. [å­˜å‚¨å¸ƒå±€ä¼˜åŒ–](#å­˜å‚¨å¸ƒå±€ä¼˜åŒ–)
8. [æ•°æ®æµè½¬åˆ†æ](#æ•°æ®æµè½¬åˆ†æ)

---

## æ•°æ®ç»“æ„æ¦‚è§ˆ

### æ ¸å¿ƒæ•°æ®ç»“æ„å±‚æ¬¡

```
UniswapV3Pool
â”‚
â”œâ”€â”€ Slot0 (ä¸»è¦çŠ¶æ€) - 1 ä¸ªå­˜å‚¨æ§½
â”‚   â”œâ”€â”€ sqrtPriceX96 (uint160) - å½“å‰ä»·æ ¼
â”‚   â”œâ”€â”€ tick (int24) - å½“å‰ tick
â”‚   â”œâ”€â”€ observationIndex (uint16)
â”‚   â”œâ”€â”€ observationCardinality (uint16)
â”‚   â”œâ”€â”€ observationCardinalityNext (uint16)
â”‚   â”œâ”€â”€ feeProtocol (uint8)
â”‚   â””â”€â”€ unlocked (bool)
â”‚
â”œâ”€â”€ Position.Info (å¤´å¯¸) - mapping(bytes32 => Info)
â”‚   â”œâ”€â”€ liquidity (uint128)
â”‚   â”œâ”€â”€ feeGrowthInside0LastX128 (uint256)
â”‚   â”œâ”€â”€ feeGrowthInside1LastX128 (uint256)
â”‚   â”œâ”€â”€ tokensOwed0 (uint128)
â”‚   â””â”€â”€ tokensOwed1 (uint128)
â”‚
â”œâ”€â”€ Tick.Info (Tick æ•°æ®) - mapping(int24 => Info)
â”‚   â”œâ”€â”€ liquidityGross (uint128)
â”‚   â”œâ”€â”€ liquidityNet (int128)
â”‚   â”œâ”€â”€ feeGrowthOutside0X128 (uint256)
â”‚   â”œâ”€â”€ feeGrowthOutside1X128 (uint256)
â”‚   â”œâ”€â”€ tickCumulativeOutside (int56)
â”‚   â”œâ”€â”€ secondsPerLiquidityOutsideX128 (uint160)
â”‚   â”œâ”€â”€ secondsOutside (uint32)
â”‚   â””â”€â”€ initialized (bool)
â”‚
â””â”€â”€ Oracle.Observation (é¢„è¨€æœº) - array[65535]
    â”œâ”€â”€ blockTimestamp (uint32)
    â”œâ”€â”€ tickCumulative (int56)
    â”œâ”€â”€ secondsPerLiquidityCumulativeX128 (uint160)
    â””â”€â”€ initialized (bool)
```

---

## Slot0 - ä¸»è¦çŠ¶æ€

### ç»“æ„ä½“å®šä¹‰

```solidity
struct Slot0 {
    uint160 sqrtPriceX96;           // å½“å‰ä»·æ ¼çš„å¹³æ–¹æ ¹ (Q64.96)
    int24 tick;                      // å½“å‰ tick
    uint16 observationIndex;         // é¢„è¨€æœºè§‚å¯Ÿç´¢å¼•
    uint16 observationCardinality;   // é¢„è¨€æœºå½“å‰å®¹é‡
    uint16 observationCardinalityNext; // é¢„è¨€æœºç›®æ ‡å®¹é‡
    uint8 feeProtocol;              // åè®®è´¹ç‡
    bool unlocked;                   // é‡å…¥é”
}
```

### å­˜å‚¨å¸ƒå±€ï¼ˆæè‡´ä¼˜åŒ–ï¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Slot0 (256 bits / 32 bytes)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sqrtPriceX96 â”‚ tick  â”‚ obIdxâ”‚ obCarâ”‚obNextâ”‚feeProâ”‚unlockedâ”‚
â”‚   160 bits   â”‚24 bitsâ”‚16 bitâ”‚16 bitâ”‚16 bitâ”‚8 bit â”‚ 1 bit  â”‚
â”‚   (20 bytes) â”‚(3 b)  â”‚(2 b) â”‚(2 b) â”‚(2 b) â”‚(1 b) â”‚ (1 b)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     æ€»å…± = 160+24+16+16+16+8+1 = 241 bits < 256 bits âœ“
```

### å­—æ®µè¯¦è§£

#### 1. sqrtPriceX96 (uint160)

```solidity
uint160 sqrtPriceX96;
```

**å«ä¹‰**: å½“å‰ä»·æ ¼çš„å¹³æ–¹æ ¹ï¼Œä½¿ç”¨ Q64.96 å®šç‚¹æ•°æ ¼å¼

**è®¡ç®—å…¬å¼**:

```
sqrtPriceX96 = sqrt(price) * 2^96
price = (sqrtPriceX96 / 2^96)^2
price = token1 / token0
```

**ä¸ºä»€ä¹ˆä½¿ç”¨å¹³æ–¹æ ¹ï¼Ÿ**

1. **æ’å®šä¹˜ç§¯å…¬å¼**: `x * y = k` â†’ `L^2 = k`
2. **ç®€åŒ–è®¡ç®—**: ä½¿ç”¨ `sqrt(price)` å¯ä»¥æ›´é«˜æ•ˆåœ°è®¡ç®—ä»£å¸æ•°é‡
3. **é¿å…é™¤æ³•**: `Î”y = L * Î”(sqrt(P))`ï¼Œåªéœ€ä¹˜æ³•

**ä¸ºä»€ä¹ˆæ˜¯ uint160ï¼Ÿ**

- è¶³å¤Ÿè¡¨ç¤ºä»»ä½•ä»¥å¤ªåŠåœ°å€ï¼ˆ20 å­—èŠ‚ = 160 ä½ï¼‰
- Q64.96 æ ¼å¼ï¼š64 ä½æ•´æ•° + 96 ä½å°æ•°
- ä»·æ ¼èŒƒå›´ï¼š2^-128 åˆ° 2^128

**ç¤ºä¾‹**:

```
ä»·æ ¼ = 1 ETH/USDC = 2000 USDC/ETH
sqrtPrice = sqrt(2000) â‰ˆ 44.72
sqrtPriceX96 = 44.72 * 2^96 â‰ˆ 3.54e30
```

#### 2. tick (int24)

```solidity
int24 tick;
```

**å«ä¹‰**: å½“å‰ä»·æ ¼å¯¹åº”çš„ tickï¼ˆç¦»æ•£åŒ–çš„ä»·æ ¼ç‚¹ï¼‰

**è®¡ç®—å…¬å¼**:

```
price = 1.0001^tick
tick = log_{1.0001}(price)
```

**å–å€¼èŒƒå›´**:

- æœ€å°å€¼ï¼š-887,272
- æœ€å¤§å€¼ï¼š887,272
- å¯¹åº”ä»·æ ¼èŒƒå›´ï¼š2^-128 åˆ° 2^128

**ä¸ºä»€ä¹ˆä½¿ç”¨ tickï¼Ÿ**

1. **ç¦»æ•£åŒ–ä»·æ ¼**: å°†è¿ç»­çš„ä»·æ ¼ç©ºé—´ç¦»æ•£åŒ–ï¼Œä¾¿äºå­˜å‚¨å’Œç´¢å¼•
2. **å¯¹æ•°åˆ»åº¦**: æ¯ä¸ª tick ä»£è¡¨ 0.01% çš„ä»·æ ¼å˜åŒ–
3. **ç©ºé—´å‹ç¼©**: int24 åªéœ€ 3 å­—èŠ‚ï¼Œå¯ä»¥è¡¨ç¤ºå·¨å¤§çš„ä»·æ ¼èŒƒå›´

**tick ä¸ä»·æ ¼çš„å…³ç³»**:

```
tick = 0   â†’ price = 1
tick = 1   â†’ price = 1.0001
tick = 100 â†’ price â‰ˆ 1.01
tick = 10000 â†’ price â‰ˆ 2.718 (e)
```

#### 3. observationIndex (uint16)

```solidity
uint16 observationIndex;
```

**å«ä¹‰**: é¢„è¨€æœºè§‚å¯Ÿæ•°ç»„ä¸­æœ€è¿‘å†™å…¥çš„è§‚å¯Ÿè®°å½•çš„ç´¢å¼•

**èŒƒå›´**: 0 åˆ° cardinality-1

**ä½œç”¨**:

- æŒ‡å‘æœ€æ–°çš„ä»·æ ¼è§‚å¯Ÿè®°å½•
- ç”¨äº TWAP è®¡ç®—
- ç¯å½¢æ•°ç»„çš„"å†™æŒ‡é’ˆ"

#### 4. observationCardinality (uint16)

```solidity
uint16 observationCardinality;
```

**å«ä¹‰**: é¢„è¨€æœºè§‚å¯Ÿæ•°ç»„å½“å‰å·²ä½¿ç”¨çš„å®¹é‡

**åˆå§‹å€¼**: 1
**æœ€å¤§å€¼**: 65,535

**å¢é•¿æœºåˆ¶**:

```solidity
// å½“å†™å…¥åˆ°æ•°ç»„æœ«å°¾ä¸”æœ‰æ‰©å®¹è¯·æ±‚æ—¶ï¼Œcardinality å¢é•¿
if (cardinalityNext > cardinality && index == cardinality - 1) {
    cardinality = cardinalityNext;
}
```

#### 5. observationCardinalityNext (uint16)

```solidity
uint16 observationCardinalityNext;
```

**å«ä¹‰**: é¢„è¨€æœºè§‚å¯Ÿæ•°ç»„çš„ç›®æ ‡å®¹é‡

**ä½œç”¨**:

- ç”¨æˆ·å¯ä»¥è°ƒç”¨ `increaseObservationCardinalityNext()` é¢„å…ˆæ‰©å®¹
- æ‰©å®¹éœ€è¦é¢„å†™å…¥æ•°æ®ï¼Œé˜²æ­¢åç»­äº¤æ˜“æ—¶çš„é«˜ gas

**æ‰©å®¹æµç¨‹**:

```
1. ç”¨æˆ·è°ƒç”¨ increaseObservationCardinalityNext(100)
2. é¢„å†™å…¥ slot[1] åˆ° slot[99]ï¼ˆblockTimestamp = 1ï¼‰
3. åç»­å†™å…¥æ—¶é€æ­¥æ¿€æ´»è¿™äº›æ§½ä½
```

#### 6. feeProtocol (uint8)

```solidity
uint8 feeProtocol;
```

**å«ä¹‰**: åè®®è´¹ç‡ï¼Œä½¿ç”¨ä½æ‰“åŒ…å­˜å‚¨ä¸¤ä¸ªä»£å¸çš„è´¹ç‡

**ä½å¸ƒå±€**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é«˜ 4 ä½     â”‚   ä½ 4 ä½    â”‚
â”‚  token1 è´¹ç‡ â”‚  token0 è´¹ç‡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æå–æ–¹å¼**:

```solidity
uint8 feeProtocol0 = feeProtocol % 16;      // ä½ 4 ä½
uint8 feeProtocol1 = feeProtocol >> 4;      // é«˜ 4 ä½
```

**å–å€¼å«ä¹‰**:

- 0: å…³é—­åè®®è´¹
- 4-10: å¼€å¯åè®®è´¹ï¼ˆåˆ†æ¯ï¼‰
  - 4 = 1/4 = 25% çš„äº¤æ˜“è´¹å½’åè®®
  - 5 = 1/5 = 20%
  - 10 = 1/10 = 10%

**ç¤ºä¾‹**:

```solidity
// è®¾ç½® token0 åè®®è´¹ = 5 (20%), token1 = 4 (25%)
feeProtocol = 4 + (5 << 4) = 4 + 80 = 84

// è§£æ
feeProtocol0 = 84 % 16 = 4   // token0: 25%
feeProtocol1 = 84 >> 4 = 5   // token1: 20%
```

#### 7. unlocked (bool)

```solidity
bool unlocked;
```

**å«ä¹‰**: é‡å…¥é”æ ‡å¿—

**çŠ¶æ€**:

- `true`: æœªé”å®šï¼Œå¯ä»¥è°ƒç”¨
- `false`: å·²é”å®šï¼Œæ­£åœ¨æ‰§è¡Œä¸­

**ä½¿ç”¨æ–¹å¼**:

```solidity
modifier lock() {
    require(slot0.unlocked, 'LOK');
    slot0.unlocked = false;  // ä¸Šé”
    _;
    slot0.unlocked = true;   // è§£é”
}
```

**ä¸ºä»€ä¹ˆæ”¾åœ¨ Slot0ï¼Ÿ**

- é‡å…¥é”ç»å¸¸è¢«è®¿é—®
- æ”¾åœ¨ Slot0 å¯ä»¥ä¸å…¶ä»–çŠ¶æ€ä¸€èµ·è¯»å–
- èŠ‚çœä¸€æ¬¡ SLOADï¼ˆ2100 gasï¼‰

### ä¸ºä»€ä¹ˆè¦æ‰“åŒ…ï¼Ÿ

**Gas èŠ‚çœ**:

```
æœªæ‰“åŒ…ï¼ˆ7 ä¸ªç‹¬ç«‹å˜é‡ï¼‰:
- 7 æ¬¡ SLOAD = 7 Ã— 2100 = 14,700 gas

æ‰“åŒ…ï¼ˆ1 ä¸ª Slot0ï¼‰:
- 1 æ¬¡ SLOAD = 2100 gas

èŠ‚çœ: 12,600 gas (85% â†“)
```

**å†…å­˜å¸ƒå±€**:

```
256 bits = 32 bytes
å·²ç”¨: 160+24+16+16+16+8+1 = 241 bits
å‰©ä½™: 15 bitsï¼ˆæœªä½¿ç”¨ï¼‰
```

---

## Position.Info - å¤´å¯¸ä¿¡æ¯

### ç»“æ„ä½“å®šä¹‰

```solidity
struct Info {
    uint128 liquidity;                    // æŒæœ‰çš„æµåŠ¨æ€§æ•°é‡
    uint256 feeGrowthInside0LastX128;     // ä¸Šæ¬¡å¿«ç…§çš„ token0 è´¹ç”¨å¢é•¿
    uint256 feeGrowthInside1LastX128;     // ä¸Šæ¬¡å¿«ç…§çš„ token1 è´¹ç”¨å¢é•¿
    uint128 tokensOwed0;                  // å¾…é¢†å–çš„ token0
    uint128 tokensOwed1;                  // å¾…é¢†å–çš„ token1
}
```

### å­˜å‚¨å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Position.Info (5 ä¸ªæ§½ä½ = 160 å­—èŠ‚)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 0: liquidity (uint128)                â”‚ 16 å­—èŠ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 1: feeGrowthInside0LastX128 (uint256) â”‚ 32 å­—èŠ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 2: feeGrowthInside1LastX128 (uint256) â”‚ 32 å­—èŠ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 3: tokensOwed0 (uint128)              â”‚ 16 å­—èŠ‚
â”‚         tokensOwed1 (uint128)              â”‚ 16 å­—èŠ‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å­—æ®µè¯¦è§£

#### 1. liquidity (uint128)

```solidity
uint128 liquidity;
```

**å«ä¹‰**: è¯¥å¤´å¯¸æŒæœ‰çš„æµåŠ¨æ€§æ•°é‡

**å•ä½**: æŠ½è±¡çš„"æµåŠ¨æ€§å•ä½"ï¼ˆä¸æ˜¯ä»£å¸æ•°é‡ï¼‰

**å…³ç³»**:

```
ä»£å¸æ•°é‡ = f(liquidity, price, tick_range)

å½“ä»·æ ¼åœ¨åŒºé—´ [Pa, Pb] å†…ï¼š
amount0 = liquidity * (1/sqrt(P) - 1/sqrt(Pb))
amount1 = liquidity * (sqrt(P) - sqrt(Pa))
```

**ä¸ºä»€ä¹ˆç”¨ uint128ï¼Ÿ**

- uint128 æœ€å¤§å€¼ â‰ˆ 3.4e38
- è¶³å¤Ÿè¡¨ç¤ºä»»ä½•åˆç†çš„æµåŠ¨æ€§æ•°é‡
- ä¸ Tick.liquidityGross ç±»å‹ä¸€è‡´

#### 2. feeGrowthInside0LastX128 (uint256)

```solidity
uint256 feeGrowthInside0LastX128;
```

**å«ä¹‰**: ä¸Šæ¬¡æ›´æ–°å¤´å¯¸æ—¶ï¼Œä»·æ ¼åŒºé—´å†… token0 çš„ç´¯ç§¯è´¹ç”¨å¢é•¿

**æ ¼å¼**: Q128.128 å®šç‚¹æ•°

**è®¡ç®—å…¬å¼**:

```
ç´¯ç§¯è´¹ç”¨å¢é•¿ = Î£ (fee_i * 2^128 / liquidity_i)
```

**ç”¨é€”**: è®¡ç®— LP åº”å¾—çš„è´¹ç”¨

```solidity
uint256 feesEarned = (feeGrowthInside0Now - feeGrowthInside0Last) 
                     * liquidity / 2^128;
```

**ä¸ºä»€ä¹ˆéœ€è¦"å¿«ç…§"ï¼Ÿ**

- æ¯æ¬¡ä¿®æ”¹å¤´å¯¸æ—¶è®°å½•å½“å‰çš„ç´¯ç§¯å€¼
- ä¸‹æ¬¡æ›´æ–°æ—¶ç”¨"å½“å‰å€¼ - ä¸Šæ¬¡å€¼"è®¡ç®—æ–°å¢è´¹ç”¨
- O(1) å¤æ‚åº¦ï¼Œæ— éœ€éå†æ‰€æœ‰äº¤æ˜“

#### 3. feeGrowthInside1LastX128 (uint256)

```solidity
uint256 feeGrowthInside1LastX128;
```

**å«ä¹‰**: token1 çš„ç´¯ç§¯è´¹ç”¨å¢é•¿å¿«ç…§ï¼ˆåŒä¸Šï¼‰

#### 4. tokensOwed0 (uint128)

```solidity
uint128 tokensOwed0;
```

**å«ä¹‰**: å¾…é¢†å–çš„ token0 æ•°é‡ï¼ˆç´¯ç§¯çš„è´¹ç”¨ + burn åæœªæå–çš„ä»£å¸ï¼‰

**æ¥æº**:

1. **äº¤æ˜“è´¹ç”¨**: ä»·æ ¼åŒºé—´å†…äº¤æ˜“äº§ç”Ÿçš„è´¹ç”¨
2. **burn**: ç§»é™¤æµåŠ¨æ€§ååº”è¿”è¿˜çš„ä»£å¸

**é¢†å–æ–¹å¼**:

```solidity
collect(recipient, tickLower, tickUpper, amount0, amount1);
```

**ä¸ºä»€ä¹ˆåˆ†ä¸¤æ­¥ï¼ˆburn + collectï¼‰ï¼Ÿ**

- burn åªæ›´æ–°çŠ¶æ€ï¼Œä¸è½¬è´¦
- collect æ‰§è¡Œå®é™…è½¬è´¦
- ç”¨æˆ·å¯ä»¥ç´¯ç§¯è´¹ç”¨ï¼Œä¸€æ¬¡æ€§æå–ï¼ŒèŠ‚çœ gas

#### 5. tokensOwed1 (uint128)

```solidity
uint128 tokensOwed1;
```

**å«ä¹‰**: å¾…é¢†å–çš„ token1 æ•°é‡ï¼ˆåŒä¸Šï¼‰

### å¤´å¯¸é”®ï¼ˆPosition Keyï¼‰

```solidity
bytes32 key = keccak256(abi.encodePacked(owner, tickLower, tickUpper));
```

**ç»„æˆ**:

- `owner`: å¤´å¯¸æ‰€æœ‰è€…åœ°å€ï¼ˆ20 å­—èŠ‚ï¼‰
- `tickLower`: ä¸‹é™ tickï¼ˆ3 å­—èŠ‚ï¼‰
- `tickUpper`: ä¸Šé™ tickï¼ˆ3 å­—èŠ‚ï¼‰

**ç‰¹ç‚¹**:

- æ¯ä¸ªç”¨æˆ·åœ¨æ¯ä¸ªä»·æ ¼åŒºé—´åªèƒ½æœ‰ä¸€ä¸ªå¤´å¯¸
- æƒ³è¦å¤šä¸ªå¤´å¯¸ï¼Ÿä½¿ç”¨ä¸åŒçš„ä»·æ ¼åŒºé—´
- å“ˆå¸Œåçš„é”®ç¡®ä¿å”¯ä¸€æ€§å’Œå®‰å…¨æ€§

### è´¹ç”¨è®¡ç®—æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ± ä¸­æ¯æ¬¡äº¤æ˜“éƒ½ä¼šæ›´æ–°å…¨å±€è´¹ç”¨å¢é•¿                 â”‚
â”‚    feeGrowthGlobal0 += fee * 2^128 / liquidity      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è®¡ç®—ä»·æ ¼åŒºé—´å†…çš„è´¹ç”¨å¢é•¿ï¼ˆgetFeeGrowthInsideï¼‰  â”‚
â”‚    feeGrowthInside = global - below - above         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è®¡ç®—å¤´å¯¸çš„æ–°å¢è´¹ç”¨                               â”‚
â”‚    newFees = (feeGrowthInside - feeGrowthInsideLast)â”‚
â”‚              * liquidity / 2^128                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç´¯åŠ åˆ° tokensOwed                                â”‚
â”‚    tokensOwed0 += newFees0                          â”‚
â”‚    tokensOwed1 += newFees1                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tick.Info - Tick ä¿¡æ¯

### ç»“æ„ä½“å®šä¹‰

```solidity
struct Info {
    uint128 liquidityGross;               // å¼•ç”¨æ­¤ tick çš„æ€»æµåŠ¨æ€§
    int128 liquidityNet;                  // è·¨è¶Šæ—¶çš„å‡€æµåŠ¨æ€§å˜åŒ–
    uint256 feeGrowthOutside0X128;        // tick å¤–éƒ¨çš„ token0 è´¹ç”¨å¢é•¿
    uint256 feeGrowthOutside1X128;        // tick å¤–éƒ¨çš„ token1 è´¹ç”¨å¢é•¿
    int56 tickCumulativeOutside;          // tick ç´¯ç§¯å€¼ï¼ˆé¢„è¨€æœºï¼‰
    uint160 secondsPerLiquidityOutsideX128; // æ¯å•ä½æµåŠ¨æ€§çš„ç§’æ•°ï¼ˆé¢„è¨€æœºï¼‰
    uint32 secondsOutside;                // åœ¨å¤–éƒ¨çš„ç§’æ•°ï¼ˆé¢„è¨€æœºï¼‰
    bool initialized;                     // æ˜¯å¦å·²åˆå§‹åŒ–
}
```

### å­˜å‚¨å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tick.Info (4 ä¸ªæ§½ä½ = 128 å­—èŠ‚)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 0: liquidityGross (uint128)           â”‚ 16 å­—èŠ‚
â”‚         liquidityNet (int128)              â”‚ 16 å­—èŠ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 1: feeGrowthOutside0X128 (uint256)    â”‚ 32 å­—èŠ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 2: feeGrowthOutside1X128 (uint256)    â”‚ 32 å­—èŠ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 3: tickCumulativeOutside (int56)      â”‚ 7 å­—èŠ‚
â”‚         secondsPerLiquidityOutsideX128     â”‚ 20 å­—èŠ‚
â”‚         secondsOutside (uint32)            â”‚ 4 å­—èŠ‚
â”‚         initialized (bool)                 â”‚ 1 å­—èŠ‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å­—æ®µè¯¦è§£

#### 1. liquidityGross (uint128)

```solidity
uint128 liquidityGross;
```

**å«ä¹‰**: å¼•ç”¨æ­¤ tick çš„æ€»æµåŠ¨æ€§ï¼ˆç»å¯¹å€¼ä¹‹å’Œï¼‰

**è®¡ç®—**:

```
liquidityGross = Î£|liquidityDelta_i|
```

**ç”¨é€”**:

- åˆ¤æ–­ tick æ˜¯å¦è¢«å¼•ç”¨ï¼ˆliquidityGross != 0ï¼‰
- è®¡ç®— tick æ˜¯å¦"ç¿»è½¬"ï¼ˆä» 0 å˜é0ï¼Œæˆ–ä»é0 å˜ 0ï¼‰

**ç¤ºä¾‹**:

```
ä½ç½® A: [tick=100, tick=200], liquidity=1000
ä½ç½® B: [tick=150, tick=200], liquidity=500

tick=100: liquidityGross = 1000
tick=150: liquidityGross = 500
tick=200: liquidityGross = 1000 + 500 = 1500
```

#### 2. liquidityNet (int128)

```solidity
int128 liquidityNet;
```

**å«ä¹‰**: è·¨è¶Šæ­¤ tick æ—¶æ´»è·ƒæµåŠ¨æ€§çš„å‡€å˜åŒ–ï¼ˆæœ‰ç¬¦å·ï¼‰

**æ–¹å‘çº¦å®š**:

```
ä»å·¦åˆ°å³è·¨è¶Šï¼ˆä»·æ ¼ä¸Šå‡ï¼‰:
- è·¨è¶Šä¸‹é™ tick: liquidityNet ä¸ºæ­£ï¼ˆæµåŠ¨æ€§æ¿€æ´»ï¼‰
- è·¨è¶Šä¸Šé™ tick: liquidityNet ä¸ºè´Ÿï¼ˆæµåŠ¨æ€§å¤±æ´»ï¼‰

ä»å³åˆ°å·¦è·¨è¶Šï¼ˆä»·æ ¼ä¸‹é™ï¼‰:
- liquidityNet çš„ç¬¦å·ç›¸å
```

**è®¡ç®—è§„åˆ™**:

```solidity
// ä¸‹é™ tick
liquidityNet += liquidityDelta;

// ä¸Šé™ tick
liquidityNet -= liquidityDelta;
```

**ç¤ºä¾‹**:

```
ä½ç½® A: [tick=100, tick=200], liquidity=1000

tick=100 (ä¸‹é™): liquidityNet = +1000
tick=200 (ä¸Šé™): liquidityNet = -1000

ä»·æ ¼ä» 90 å‡åˆ° 110:
- è·¨è¶Š tick=100
- æ´»è·ƒæµåŠ¨æ€§å¢åŠ  1000
```

#### 3. feeGrowthOutside0X128 (uint256)

```solidity
uint256 feeGrowthOutside0X128;
```

**å«ä¹‰**: tick "å¤–éƒ¨"çš„ token0 ç´¯ç§¯è´¹ç”¨å¢é•¿

**"å¤–éƒ¨"çš„å®šä¹‰**:

```
å¦‚æœ å½“å‰tick >= æ­¤tick:
    å¤–éƒ¨ = å·¦ä¾§ï¼ˆä»·æ ¼æ›´ä½çš„ä¸€ä¾§ï¼‰
å¦åˆ™:
    å¤–éƒ¨ = å³ä¾§ï¼ˆä»·æ ¼æ›´é«˜çš„ä¸€ä¾§ï¼‰
```

**ä¸ºä»€ä¹ˆéœ€è¦ outsideï¼Ÿ**

- ç”¨äºè®¡ç®—ä»·æ ¼åŒºé—´"å†…éƒ¨"çš„è´¹ç”¨
- å…¬å¼ï¼š`feeInside = feeGlobal - feeBelow - feeAbove`

**åˆå§‹åŒ–æ—¶æœº**:

```solidity
// tick é¦–æ¬¡è¢«å¼•ç”¨æ—¶
if (tick <= currentTick) {
    feeGrowthOutside = feeGrowthGlobal;  // å‡è®¾æ‰€æœ‰å†å²è´¹ç”¨åœ¨å·¦ä¾§
} else {
    feeGrowthOutside = 0;  // å‡è®¾æ‰€æœ‰å†å²è´¹ç”¨åœ¨å³ä¾§
}
```

**è·¨è¶Šæ—¶çš„æ›´æ–°**:

```solidity
// æ¯æ¬¡è·¨è¶Š tick æ—¶ï¼Œ"ç¿»è½¬" outside çš„å«ä¹‰
feeGrowthOutside = feeGrowthGlobal - feeGrowthOutside;
```

#### 4. feeGrowthOutside1X128 (uint256)

```solidity
uint256 feeGrowthOutside1X128;
```

**å«ä¹‰**: token1 çš„å¤–éƒ¨è´¹ç”¨å¢é•¿ï¼ˆåŒä¸Šï¼‰

#### 5. tickCumulativeOutside (int56)

```solidity
int56 tickCumulativeOutside;
```

**å«ä¹‰**: tick å¤–éƒ¨çš„ tick ç´¯ç§¯å€¼ï¼ˆç”¨äº TWAP é¢„è¨€æœºï¼‰

**ç´¯ç§¯å…¬å¼**:

```
tickCumulative += currentTick * timeDelta
```

**ä¸ºä»€ä¹ˆæ˜¯ int56ï¼Ÿ**

- éœ€è¦å­˜å‚¨é•¿æ—¶é—´çš„ç´¯ç§¯å€¼
- int56 å¯ä»¥å­˜å‚¨çº¦ 2.28 Ã— 10^15 çš„å€¼
- è¶³å¤Ÿè¡¨ç¤ºæ•°å¹´çš„ç´¯ç§¯

#### 6. secondsPerLiquidityOutsideX128 (uint160)

```solidity
uint160 secondsPerLiquidityOutsideX128;
```

**å«ä¹‰**: tick å¤–éƒ¨çš„"æ¯å•ä½æµåŠ¨æ€§çš„ç§’æ•°"ç´¯ç§¯å€¼

**ç´¯ç§¯å…¬å¼**:

```
secondsPerLiquidity += timeDelta * 2^128 / liquidity
```

**ç”¨é€”**: è®¡ç®—ä»·æ ¼åœ¨ç‰¹å®šåŒºé—´å†…çš„æ—¶é—´åŠ æƒæµåŠ¨æ€§

#### 7. secondsOutside (uint32)

```solidity
uint32 secondsOutside;
```

**å«ä¹‰**: ä»·æ ¼åœ¨ tick å¤–éƒ¨çš„æ€»ç§’æ•°

**ç´¯ç§¯å…¬å¼**:

```
secondsOutside += timeDelta
```

**ä¸ºä»€ä¹ˆæ˜¯ uint32ï¼Ÿ**

- uint32 å¯ä»¥è¡¨ç¤ºçº¦ 136 å¹´çš„ç§’æ•°
- è¶³å¤Ÿé•¿ï¼Œä¸”èŠ‚çœå­˜å‚¨ç©ºé—´

#### 8. initialized (bool)

```solidity
bool initialized;
```

**å«ä¹‰**: tick æ˜¯å¦å·²åˆå§‹åŒ–ï¼ˆæ˜¯å¦æœ‰æµåŠ¨æ€§å¼•ç”¨ï¼‰

**ç­‰ä»·æ€§**:

```
initialized == true âŸº liquidityGross > 0
```

**ä¸ºä»€ä¹ˆéœ€è¦é¢å¤–çš„å¸ƒå°”å€¼ï¼Ÿ**

- é˜²æ­¢åœ¨è·¨è¶Šæ–°åˆå§‹åŒ–çš„ tick æ—¶äº§ç”Ÿæ˜‚è´µçš„ SSTORE
- åˆå§‹åŒ–æ—¶è®¾ç½®ä¸º trueï¼Œä¹‹åä¸å†æ”¹å˜ï¼ˆé™¤éæ¸…é™¤ï¼‰

### Tick çš„ "inside" å’Œ "outside" æ¦‚å¿µ

è¿™æ˜¯ Uniswap V3 æœ€å·§å¦™çš„è®¾è®¡ä¹‹ä¸€ï¼

```
ä»·æ ¼è½´:  â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
          tickLower  current   tickUpper

æƒ…å†µ 1: current < tickLower
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  outside   â”‚ inside â”‚ outside
â”‚  (below)   â”‚        â”‚ (above)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€
    â†‘ current

æƒ…å†µ 2: tickLower <= current < tickUpper
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  outside   â”‚ inside â”‚ outside
â”‚  (below)   â”‚   â†‘    â”‚ (above)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€currentâ”´â”€â”€â”€â”€â”€â”€â”€â”€

æƒ…å†µ 3: current >= tickUpper
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  outside   â”‚ inside â”‚ outsideâ”‚
â”‚  (below)   â”‚        â”‚ (above)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â†‘â”€â”€â”€â”€â”€
                      current
```

**è®¡ç®— inside çš„å…¬å¼**:

```solidity
feeGrowthBelow = (currentTick >= tickLower) 
    ? feeGrowthOutsideLower
    : feeGrowthGlobal - feeGrowthOutsideLower;

feeGrowthAbove = (currentTick < tickUpper)
    ? feeGrowthOutsideUpper
    : feeGrowthGlobal - feeGrowthOutsideUpper;

feeGrowthInside = feeGrowthGlobal - feeGrowthBelow - feeGrowthAbove;
```

---

## Oracle.Observation - é¢„è¨€æœºè§‚å¯Ÿ

### ç»“æ„ä½“å®šä¹‰

```solidity
struct Observation {
    uint32 blockTimestamp;                      // è§‚å¯Ÿçš„åŒºå—æ—¶é—´æˆ³
    int56 tickCumulative;                       // tick ç´¯ç§¯å€¼
    uint160 secondsPerLiquidityCumulativeX128;  // æµåŠ¨æ€§å€’æ•°ç´¯ç§¯å€¼
    bool initialized;                           // æ˜¯å¦å·²åˆå§‹åŒ–
}
```

### å­˜å‚¨å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Observation (2 ä¸ªæ§½ä½ = 64 å­—èŠ‚)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot 0: blockTimestamp (uint32)            â”‚ 4 å­—èŠ‚
â”‚         tickCumulative (int56)             â”‚ 7 å­—èŠ‚
â”‚         secondsPerLiquidityX128 (uint160)  â”‚ 20 å­—èŠ‚
â”‚         initialized (bool)                 â”‚ 1 å­—èŠ‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»è®¡: 32 å­—èŠ‚ï¼ˆ1 ä¸ªæ§½ä½ï¼æè‡´ä¼˜åŒ–ï¼‰
```

### å­—æ®µè¯¦è§£

#### 1. blockTimestamp (uint32)

```solidity
uint32 blockTimestamp;
```

**å«ä¹‰**: è§‚å¯Ÿè®°å½•çš„æ—¶é—´æˆ³

**ä¸ºä»€ä¹ˆæ˜¯ uint32ï¼Ÿ**

- uint32 å¯ä»¥è¡¨ç¤ºåˆ° 2106 å¹´
- èŠ‚çœå­˜å‚¨ç©ºé—´ï¼ˆ4 å­—èŠ‚ vs 32 å­—èŠ‚ï¼‰
- æº¢å‡ºå¤„ç†ï¼šä»£ç ä¸­æœ‰ç‰¹æ®Šçš„æ—¶é—´æ¯”è¾ƒé€»è¾‘

**æº¢å‡ºå®‰å…¨æ¯”è¾ƒ**:

```solidity
function lte(uint32 time, uint32 a, uint32 b) returns (bool) {
    if (a <= time && b <= time) return a <= b;
    
    // å¤„ç†æº¢å‡ºæƒ…å†µ
    uint256 aAdjusted = a > time ? a : a + 2**32;
    uint256 bAdjusted = b > time ? b : b + 2**32;
    return aAdjusted <= bAdjusted;
}
```

#### 2. tickCumulative (int56)

```solidity
int56 tickCumulative;
```

**å«ä¹‰**: tick çš„ç´¯ç§¯å€¼

**è®¡ç®—å…¬å¼**:

```
tickCumulative[t] = tickCumulative[t-1] + currentTick * Î”t
```

**ç”¨é€”**: è®¡ç®— TWAPï¼ˆæ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼‰

```
TWAP = (tickCumulative[t2] - tickCumulative[t1]) / (t2 - t1)
price = 1.0001^TWAP
```

**ä¸ºä»€ä¹ˆæ˜¯ int56ï¼Ÿ**

- éœ€è¦å­˜å‚¨å¯èƒ½éå¸¸å¤§çš„ç´¯ç§¯å€¼
- tick å¯ä»¥æ˜¯è´Ÿæ•°ï¼ˆä»·æ ¼ < 1ï¼‰
- int56 è¶³å¤Ÿå­˜å‚¨æ•°å¹´çš„ç´¯ç§¯

#### 3. secondsPerLiquidityCumulativeX128 (uint160)

```solidity
uint160 secondsPerLiquidityCumulativeX128;
```

**å«ä¹‰**: æ¯å•ä½æµåŠ¨æ€§çš„ç§’æ•°ç´¯ç§¯å€¼

**è®¡ç®—å…¬å¼**:

```
secondsPerLiquidityX128[t] = secondsPerLiquidityX128[t-1] 
                            + (Î”t * 2^128) / liquidity
```

**ç”¨é€”**: è®¡ç®—ä»·æ ¼åœ¨ç‰¹å®šåŒºé—´å†…çš„æ—¶é—´åŠ æƒæµåŠ¨æ€§

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ**

- è¡¡é‡æµåŠ¨æ€§çš„"æ—¶é—´ä»·å€¼"
- LP å¯ä»¥æ ¹æ®æä¾›æµåŠ¨æ€§çš„æ—¶é—´è·å¾—å¥–åŠ±
- ç”¨äºæ›´å¤æ‚çš„ DeFi ç­–ç•¥

#### 4. initialized (bool)

```solidity
bool initialized;
```

**å«ä¹‰**: è¯¥è§‚å¯Ÿæ§½ä½æ˜¯å¦å·²åˆå§‹åŒ–

**ç”¨é€”**:

- åŒºåˆ†"æœªå†™å…¥"å’Œ"å†™å…¥ä½†å€¼ä¸º 0"
- ç”¨äºäºŒåˆ†æŸ¥æ‰¾æ—¶è·³è¿‡æœªåˆå§‹åŒ–çš„æ§½ä½

### è§‚å¯Ÿæ•°ç»„ç»“æ„

```solidity
Oracle.Observation[65535] public observations;
```

**ç¯å½¢æ•°ç»„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Index:  0   1   2   3  ...  65534    â”‚
â”‚  State:  â—‹   â—   â—   â—  ...   â—‹       â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚          å·²ä½¿ç”¨: cardinality           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
    observationIndex (å†™æŒ‡é’ˆ)

â— = å·²åˆå§‹åŒ–
â—‹ = æœªåˆå§‹åŒ–
```

**å†™å…¥é€»è¾‘**:

```solidity
// è®¡ç®—ä¸‹ä¸€ä¸ªç´¢å¼•ï¼ˆç¯å½¢ï¼‰
indexUpdated = (index + 1) % cardinality;

// å†™å…¥æ–°è§‚å¯Ÿ
observations[indexUpdated] = transform(last, timestamp, tick, liquidity);
```

### TWAP è®¡ç®—ç¤ºä¾‹

```
æ—¶åˆ» t1: tick = 100, tickCumulative = 50000
æ—¶åˆ» t2: tick = 120, tickCumulative = 53600
æ—¶é—´å·®: Î”t = 3600 ç§’ï¼ˆ1 å°æ—¶ï¼‰

TWAP = (53600 - 50000) / 3600 = 1 tick/ç§’
å¹³å‡ tick â‰ˆ 100

å¹³å‡ä»·æ ¼ = 1.0001^100 â‰ˆ 1.01005
```

---

## å…¶ä»–é‡è¦ç»“æ„

### 1. ProtocolFees

```solidity
struct ProtocolFees {
    uint128 token0;  // ç´¯ç§¯çš„ token0 åè®®è´¹
    uint128 token1;  // ç´¯ç§¯çš„ token1 åè®®è´¹
}
```

**å­˜å‚¨å¸ƒå±€**: 1 ä¸ªæ§½ä½ï¼ˆ32 å­—èŠ‚ï¼‰

**ç”¨é€”**: è®°å½•åº”æ”¯ä»˜ç»™åè®®çš„è´¹ç”¨

### 2. ModifyPositionParams

```solidity
struct ModifyPositionParams {
    address owner;          // å¤´å¯¸æ‰€æœ‰è€…
    int24 tickLower;        // ä¸‹é™ tick
    int24 tickUpper;        // ä¸Šé™ tick
    int128 liquidityDelta;  // æµåŠ¨æ€§å˜åŒ–ï¼ˆæ­£=æ·»åŠ ï¼Œè´Ÿ=ç§»é™¤ï¼‰
}
```

**ç”¨é€”**: ä½œä¸ºå‚æ•°ä¼ é€’ç»™ `_modifyPosition()` å†…éƒ¨å‡½æ•°

### 3. SwapCache

```solidity
struct SwapCache {
    uint8 feeProtocol;                         // åè®®è´¹ç‡
    uint128 liquidityStart;                    // èµ·å§‹æµåŠ¨æ€§
    uint32 blockTimestamp;                     // æ—¶é—´æˆ³
    int56 tickCumulative;                      // tick ç´¯ç§¯å€¼ï¼ˆç¼“å­˜ï¼‰
    uint160 secondsPerLiquidityCumulativeX128; // æµåŠ¨æ€§ç´¯ç§¯å€¼ï¼ˆç¼“å­˜ï¼‰
    bool computedLatestObservation;            // æ˜¯å¦å·²è®¡ç®—æœ€æ–°è§‚å¯Ÿ
}
```

**ç”¨é€”**: åœ¨ swap è¿‡ç¨‹ä¸­ç¼“å­˜æ•°æ®ï¼Œé¿å…é‡å¤ SLOAD

### 4. SwapState

```solidity
struct SwapState {
    int256 amountSpecifiedRemaining;  // å‰©ä½™å¾…äº¤æ˜“æ•°é‡
    int256 amountCalculated;          // å·²è®¡ç®—çš„è¾“å‡ºæ•°é‡
    uint160 sqrtPriceX96;             // å½“å‰ä»·æ ¼
    int24 tick;                       // å½“å‰ tick
    uint256 feeGrowthGlobalX128;      // è´¹ç”¨å¢é•¿
    uint128 protocolFee;              // åè®®è´¹ç´¯ç§¯
    uint128 liquidity;                // å½“å‰æµåŠ¨æ€§
}
```

**ç”¨é€”**: è¿½è¸ª swap è¿‡ç¨‹ä¸­çš„çŠ¶æ€å˜åŒ–

### 5. StepComputations

```solidity
struct StepComputations {
    uint160 sqrtPriceStartX96;  // æ­¥éª¤èµ·å§‹ä»·æ ¼
    int24 tickNext;             // ä¸‹ä¸€ä¸ª tick
    bool initialized;           // ä¸‹ä¸€ä¸ª tick æ˜¯å¦å·²åˆå§‹åŒ–
    uint160 sqrtPriceNextX96;   // ä¸‹ä¸€ä¸ª tick çš„ä»·æ ¼
    uint256 amountIn;           // è¾“å…¥æ•°é‡
    uint256 amountOut;          // è¾“å‡ºæ•°é‡
    uint256 feeAmount;          // è´¹ç”¨æ•°é‡
}
```

**ç”¨é€”**: è®¡ç®—å•æ­¥äº¤æ˜“çš„å„é¡¹æ•°å€¼

---

## å­˜å‚¨å¸ƒå±€ä¼˜åŒ–

### Gas ä¼˜åŒ–ç­–ç•¥æ€»ç»“

#### 1. å˜é‡æ‰“åŒ…

```solidity
// âŒ æœªä¼˜åŒ–ï¼ˆ7 ä¸ªæ§½ä½ï¼‰
uint160 sqrtPriceX96;      // Slot 0
int24 tick;                // Slot 1
uint16 observationIndex;   // Slot 2
// ... æ¯ä¸ªå˜é‡å ä¸€ä¸ªæ§½ä½

// âœ… ä¼˜åŒ–åï¼ˆ1 ä¸ªæ§½ä½ï¼‰
struct Slot0 {
    uint160 sqrtPriceX96;           // 20 å­—èŠ‚
    int24 tick;                      // 3 å­—èŠ‚
    uint16 observationIndex;         // 2 å­—èŠ‚
    uint16 observationCardinality;   // 2 å­—èŠ‚
    uint16 observationCardinalityNext; // 2 å­—èŠ‚
    uint8 feeProtocol;              // 1 å­—èŠ‚
    bool unlocked;                   // 1 å­—èŠ‚
    // æ€»è®¡ 31 å­—èŠ‚ < 32 å­—èŠ‚ âœ“
}
```

**èŠ‚çœ**: 6 ä¸ª SLOAD = 12,600 gas

#### 2. ä½æ‰“åŒ…

```solidity
// feeProtocol ä½¿ç”¨ 1 ä¸ªå­—èŠ‚å­˜å‚¨ä¸¤ä¸ªè´¹ç‡
uint8 feeProtocol = token0Fee + (token1Fee << 4);
```

**èŠ‚çœ**: 1 ä¸ªå­˜å‚¨æ§½ = 20,000 gas (SSTORE)

#### 3. è§‚å¯Ÿè®°å½•ä¼˜åŒ–

```solidity
// Observation æ‰“åŒ…åˆ° 1 ä¸ªæ§½ä½
struct Observation {
    uint32 blockTimestamp;      // 4 å­—èŠ‚
    int56 tickCumulative;       // 7 å­—èŠ‚
    uint160 secondsPerX128;     // 20 å­—èŠ‚
    bool initialized;           // 1 å­—èŠ‚
    // æ€»è®¡ 32 å­—èŠ‚ = æ­£å¥½ 1 ä¸ªæ§½ä½
}
```

**èŠ‚çœ**: æ¯ä¸ªè§‚å¯Ÿè®°å½• 1 ä¸ªæ§½ä½

### å­˜å‚¨æ“ä½œæˆæœ¬

| æ“ä½œ | Gas æˆæœ¬ | è¯´æ˜ |
|------|---------|------|
| SLOAD | 2,100 | è¯»å–å­˜å‚¨æ§½ |
| SSTORE (0â†’é0) | 20,000 | é¦–æ¬¡å†™å…¥ |
| SSTORE (é0â†’é0) | 5,000 | æ›´æ–°å·²æœ‰å€¼ |
| SSTORE (é0â†’0) | 5,000 - 15,000 | æ¸…é™¤ï¼ˆæœ‰é€€æ¬¾ï¼‰|

### ä¼˜åŒ–æŠ€å·§

1. **ç¼“å­˜åˆ°å†…å­˜**

```solidity
Slot0 memory _slot0 = slot0;  // ä¸€æ¬¡ SLOAD
// å¤šæ¬¡ä½¿ç”¨ _slot0ï¼Œé¿å…é‡å¤ SLOAD
```

1. **æ‰¹é‡æ›´æ–°**

```solidity
// âŒ åˆ†åˆ«æ›´æ–°
slot0.sqrtPriceX96 = newPrice;  // SSTORE
slot0.tick = newTick;            // SSTORE

// âœ… ä¸€æ¬¡æ›´æ–°
slot0 = Slot0({...});  // 1 æ¬¡ SSTORE
```

1. **å»¶è¿Ÿå†™å…¥**

```solidity
// åªæœ‰åœ¨éœ€è¦æ—¶æ‰å†™å…¥å­˜å‚¨
if (state.tick != slot0Start.tick) {
    slot0.tick = state.tick;
}
```

---

## æ•°æ®æµè½¬åˆ†æ

### 1. Mint æµç¨‹ä¸­çš„æ•°æ®æµè½¬

```
ç”¨æˆ·è°ƒç”¨ mint(recipient, tickLower, tickUpper, amount, data)
    â”‚
    â”œâ”€â†’ è¯»å– Slot0
    â”‚   â””â”€â†’ ç¼“å­˜å½“å‰ä»·æ ¼å’Œ tick
    â”‚
    â”œâ”€â†’ æ›´æ–° Position.Info
    â”‚   â”œâ”€â†’ è®¡ç®—æ–°å¢è´¹ç”¨
    â”‚   â”œâ”€â†’ liquidity += amount
    â”‚   â””â”€â†’ æ›´æ–° feeGrowthInsideLast
    â”‚
    â”œâ”€â†’ æ›´æ–° Tick.Info (tickLower å’Œ tickUpper)
    â”‚   â”œâ”€â†’ liquidityGross += amount
    â”‚   â”œâ”€â†’ liquidityNet Â± amount
    â”‚   â””â”€â†’ å¦‚æœç¿»è½¬ï¼Œæ›´æ–° TickBitmap
    â”‚
    â”œâ”€â†’ å¦‚æœå½“å‰ä»·æ ¼åœ¨åŒºé—´å†…
    â”‚   â”œâ”€â†’ æ›´æ–° liquidity (å…¨å±€)
    â”‚   â””â”€â†’ å†™å…¥ Oracle.Observation
    â”‚
    â””â”€â†’ è®¡ç®—å¹¶è¿”å›éœ€è¦çš„ token0 å’Œ token1 æ•°é‡
```

### 2. Swap æµç¨‹ä¸­çš„æ•°æ®æµè½¬

```
ç”¨æˆ·è°ƒç”¨ swap(recipient, zeroForOne, amountSpecified, sqrtPriceLimit, data)
    â”‚
    â”œâ”€â†’ è¯»å– Slot0
    â”‚   â””â”€â†’ ç¼“å­˜èµ·å§‹çŠ¶æ€åˆ° SwapCache
    â”‚
    â”œâ”€â†’ åˆå§‹åŒ– SwapState
    â”‚   â”œâ”€â†’ amountRemaining = amountSpecified
    â”‚   â”œâ”€â†’ currentPrice = slot0.sqrtPriceX96
    â”‚   â””â”€â†’ currentTick = slot0.tick
    â”‚
    â”œâ”€â†’ While (amountRemaining != 0 && price != priceLimit)
    â”‚   â”‚
    â”‚   â”œâ”€â†’ ä½¿ç”¨ TickBitmap æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–çš„ tick
    â”‚   â”‚   â””â”€â†’ O(1) å¤æ‚åº¦çš„ä½å›¾æŸ¥æ‰¾
    â”‚   â”‚
    â”‚   â”œâ”€â†’ ä½¿ç”¨ SwapMath è®¡ç®—å•æ­¥äº¤æ˜“
    â”‚   â”‚   â”œâ”€â†’ amountIn
    â”‚   â”‚   â”œâ”€â†’ amountOut
    â”‚   â”‚   â””â”€â†’ feeAmount
    â”‚   â”‚
    â”‚   â”œâ”€â†’ æ›´æ–° feeGrowthGlobal
    â”‚   â”‚   â””â”€â†’ += feeAmount * 2^128 / liquidity
    â”‚   â”‚
    â”‚   â”œâ”€â†’ å¦‚æœè·¨è¶Šäº† tick
    â”‚   â”‚   â”œâ”€â†’ è°ƒç”¨ Tick.cross()
    â”‚   â”‚   â”‚   â””â”€â†’ "ç¿»è½¬" outside æ•°æ®
    â”‚   â”‚   â””â”€â†’ æ›´æ–°æ´»è·ƒæµåŠ¨æ€§
    â”‚   â”‚       â””â”€â†’ liquidity Â± liquidityNet
    â”‚   â”‚
    â”‚   â””â”€â†’ æ›´æ–° SwapState
    â”‚       â”œâ”€â†’ amountRemaining -= amountIn
    â”‚       â””â”€â†’ currentPrice = newPrice
    â”‚
    â”œâ”€â†’ æ›´æ–° Slot0
    â”‚   â”œâ”€â†’ sqrtPriceX96 = finalPrice
    â”‚   â”œâ”€â†’ tick = finalTick
    â”‚   â””â”€â†’ å¦‚æœ tick å˜åŒ–ï¼Œå†™å…¥ Oracle
    â”‚
    â””â”€â†’ è½¬è´¦ä»£å¸ï¼ˆé€šè¿‡å›è°ƒ + ä½™é¢éªŒè¯ï¼‰
```

### 3. è´¹ç”¨ç´¯ç§¯æµç¨‹

```
äº¤æ˜“å‘ç”Ÿ
    â”‚
    â”œâ”€â†’ è®¡ç®—è´¹ç”¨
    â”‚   â””â”€â†’ fee = amountIn * feePips / 1e6
    â”‚
    â”œâ”€â†’ æ›´æ–°å…¨å±€è´¹ç”¨å¢é•¿
    â”‚   â”œâ”€â†’ feeGrowthGlobal0X128 += fee * 2^128 / liquidity
    â”‚   â””â”€â†’ feeGrowthGlobal1X128 += fee * 2^128 / liquidity
    â”‚
    â”œâ”€â†’ å¦‚æœå¯ç”¨åè®®è´¹
    â”‚   â”œâ”€â†’ protocolFee = fee / feeProtocol
    â”‚   â””â”€â†’ protocolFees.token0 += protocolFee
    â”‚
    â””â”€â†’ LP åœ¨æ›´æ–°å¤´å¯¸æ—¶
        â”œâ”€â†’ è®¡ç®— feeGrowthInside
        â”‚   â””â”€â†’ global - below - above
        â”‚
        â”œâ”€â†’ è®¡ç®—åº”å¾—è´¹ç”¨
        â”‚   â””â”€â†’ (feeGrowthInside - feeGrowthInsideLast) * liquidity / 2^128
        â”‚
        â””â”€â†’ ç´¯åŠ åˆ° tokensOwed
            â””â”€â†’ position.tokensOwed0 += newFees
```

### 4. Oracle æ›´æ–°æµç¨‹

```
éœ€è¦æ›´æ–° Oracleï¼ˆswap æˆ– mint/burn æ—¶ tick å˜åŒ–ï¼‰
    â”‚
    â”œâ”€â†’ æ£€æŸ¥æ˜¯å¦åŒä¸€åŒºå—
    â”‚   â””â”€â†’ å¦‚æœ timestamp ç›¸åŒï¼Œè·³è¿‡ï¼ˆæ¯åŒºå—æœ€å¤š 1 æ¬¡ï¼‰
    â”‚
    â”œâ”€â†’ è®¡ç®—æ–°çš„ç´¯ç§¯å€¼
    â”‚   â”œâ”€â†’ tickCumulative += currentTick * timeDelta
    â”‚   â””â”€â†’ secondsPerLiquidityX128 += timeDelta * 2^128 / liquidity
    â”‚
    â”œâ”€â†’ ç¡®å®šå†™å…¥ä½ç½®
    â”‚   â”œâ”€â†’ index = (oldIndex + 1) % cardinality
    â”‚   â””â”€â†’ å¦‚æœåˆ°è¾¾æœ«å°¾ä¸”æœ‰æ‰©å®¹è¯·æ±‚ï¼Œå¢åŠ  cardinality
    â”‚
    â”œâ”€â†’ å†™å…¥æ–°è§‚å¯Ÿ
    â”‚   â””â”€â†’ observations[index] = newObservation
    â”‚
    â””â”€â†’ æ›´æ–° Slot0
        â”œâ”€â†’ observationIndex = newIndex
        â””â”€â†’ observationCardinality = newCardinality
```

---

## æ€»ç»“

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **æè‡´çš„ Gas ä¼˜åŒ–**
   - å˜é‡æ‰“åŒ…ï¼ˆSlot0ï¼‰
   - ä½æ‰“åŒ…ï¼ˆfeeProtocolï¼‰
   - ç¼“å­˜å¸¸ç”¨æ•°æ®

2. **O(1) å¤æ‚åº¦ç®—æ³•**
   - è´¹ç”¨ç´¯ç§¯ï¼ˆæ— éœ€éå†äº¤æ˜“ï¼‰
   - Tick æŸ¥æ‰¾ï¼ˆä½å›¾ç´¢å¼•ï¼‰
   - å¤´å¯¸æ›´æ–°ï¼ˆç›´æ¥è®¡ç®—ï¼‰

3. **æ•°å­¦ç²¾åº¦**
   - Q64.96 å®šç‚¹æ•°ï¼ˆä»·æ ¼ï¼‰
   - Q128.128 å®šç‚¹æ•°ï¼ˆè´¹ç”¨ï¼‰
   - é¿å…æµ®ç‚¹æ•°ä¸ç²¾ç¡®

4. **å®‰å…¨æ€§**
   - é‡å…¥ä¿æŠ¤ï¼ˆunlockedï¼‰
   - æº¢å‡ºæ£€æŸ¥ï¼ˆSafeMathï¼‰
   - ä½™é¢éªŒè¯ï¼ˆè€Œéè¿”å›å€¼ï¼‰

5. **çµæ´»æ€§**
   - é›†ä¸­æµåŠ¨æ€§ï¼ˆä»»æ„ä»·æ ¼åŒºé—´ï¼‰
   - å¤šçº§è´¹ç‡ï¼ˆ0.05%/0.3%/1%ï¼‰
   - å¯æ‰©å±•çš„é¢„è¨€æœº

### æ•°æ®ç»“æ„å…³ç³»å›¾

```
Pool (æ± )
  â”‚
  â”œâ”€ Slot0 (å½“å‰çŠ¶æ€)
  â”‚   â””â”€ sqrtPriceX96, tick, unlocked...
  â”‚
  â”œâ”€ Position.Info (å¤´å¯¸) [mapping]
  â”‚   â””â”€ key: keccak256(owner, tickLower, tickUpper)
  â”‚       â””â”€ liquidity, feeGrowthLast, tokensOwed
  â”‚
  â”œâ”€ Tick.Info (Tick æ•°æ®) [mapping]
  â”‚   â””â”€ key: tick (int24)
  â”‚       â””â”€ liquidityGross/Net, feeGrowthOutside
  â”‚
  â”œâ”€ TickBitmap (ä½å›¾ç´¢å¼•) [mapping]
  â”‚   â””â”€ key: wordPos (int16)
  â”‚       â””â”€ value: uint256 (256 ä¸ª tick çš„ä½)
  â”‚
  â””â”€ Oracle.Observation (é¢„è¨€æœº) [array]
      â””â”€ index: 0 to 65534
          â””â”€ timestamp, tickCumulative, secondsPerLiquidityX128
```

---

## æ•°æ®ç»“æ„å˜åŒ–å®ä¾‹æ¼”ç¤º

ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™äº›æ•°æ®ç»“æ„å¦‚ä½•å·¥ä½œï¼Œè®©æˆ‘ä»¬é€šè¿‡å…·ä½“ç¤ºä¾‹æ¥æ¼”ç¤ºåœ¨ä¸åŒæ“ä½œä¸‹çš„æ•°æ®å˜åŒ–ã€‚

### åœºæ™¯è®¾ç½®

å‡è®¾ä¸€ä¸ª ETH/USDC äº¤æ˜“æ± ï¼š

- **token0**: USDC
- **token1**: ETH
- **fee**: 3000 (0.3%)
- **tickSpacing**: 60
- **åˆå§‹ä»·æ ¼**: 1 ETH = 2000 USDC

### åœºæ™¯ 1ï¼šæ± åˆå§‹åŒ–

#### æµç¨‹å›¾

```mermaid
graph TD
    A[è°ƒç”¨ initialize] --> B[è®¡ç®—åˆå§‹ tick]
    B --> C[è®¾ç½® Slot0]
    C --> D[åˆå§‹åŒ– Oracle.Observation 0]
    D --> E[è®¾ç½® unlocked = true]
    E --> F[æ± åˆå§‹åŒ–å®Œæˆ]
    
    style A fill:#e1f5ff
    style F fill:#c8e6c9
```

#### çŠ¶æ€åˆå§‹åŒ–å›¾

```mermaid
stateDiagram-v2
    [*] --> æœªåˆå§‹åŒ–
    æœªåˆå§‹åŒ– --> åˆå§‹åŒ–ä¸­: initialize()
    åˆå§‹åŒ–ä¸­ --> è®¾ç½®ä»·æ ¼: sqrtPriceX96 = 3.54e30
    è®¾ç½®ä»·æ ¼ --> è®¾ç½®tick: tick = 76318
    è®¾ç½®tick --> åˆå§‹åŒ–Oracle: observation[0]
    åˆå§‹åŒ–Oracle --> å·²åˆå§‹åŒ–: unlocked = true
    å·²åˆå§‹åŒ– --> [*]
```

#### æ“ä½œ

```solidity
pool.initialize(sqrtPriceX96);
// price = 2000, sqrtPrice = 44.72, sqrtPriceX96 = 3.54e30
```

#### æ•°æ®ç»“æ„çŠ¶æ€

**Slot0**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sqrtPriceX96:  3543191142285914246547271808000  â”‚
â”‚ tick:          76318                             â”‚
â”‚ observationIndex: 0                              â”‚
â”‚ observationCardinality: 1                        â”‚
â”‚ observationCardinalityNext: 1                    â”‚
â”‚ feeProtocol: 0                                   â”‚
â”‚ unlocked: true                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Oracle.Observation[0]**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ blockTimestamp: 1705315200 (å½“å‰æ—¶é—´)           â”‚
â”‚ tickCumulative: 0                                â”‚
â”‚ secondsPerLiquidityCumulativeX128: 0             â”‚
â”‚ initialized: true                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…¨å±€çŠ¶æ€**:

```
liquidity: 0
feeGrowthGlobal0X128: 0
feeGrowthGlobal1X128: 0
```

---

### åœºæ™¯ 2ï¼šAlice æ·»åŠ æµåŠ¨æ€§

#### æ•°æ®æµè½¬åºåˆ—å›¾

```mermaid
sequenceDiagram
    participant Alice
    participant Pool
    participant Position
    participant Tick
    participant Bitmap
    
    Alice->>Pool: mint(75060, 77640, 1M)
    Pool->>Pool: è®¡ç®—æ‰€éœ€ä»£å¸<br/>1040 USDC + 2.29 ETH
    Pool->>Position: åˆ›å»º Position.Info[key_Alice]
    Pool->>Tick: æ›´æ–° Tick.Info[75060]<br/>liquidityNet = +1M
    Pool->>Tick: æ›´æ–° Tick.Info[77640]<br/>liquidityNet = -1M
    Pool->>Bitmap: è®¾ç½® tick ä½<br/>bitmap[293] |= 1<<36<br/>bitmap[303] |= 1<<72
    Pool->>Pool: æ›´æ–°å…¨å±€æµåŠ¨æ€§<br/>liquidity = 1M
    Pool-->>Alice: è¿”å›æ‰€éœ€ä»£å¸æ•°é‡
    Alice->>Pool: è½¬å…¥ä»£å¸
```

#### æµåŠ¨æ€§åŒºé—´å¯è§†åŒ–

```mermaid
graph LR
    subgraph "ä»·æ ¼è½´"
        A[1800 USDC] -->|Alice ä¸‹é™| B[2000 USDC<br/>å½“å‰ä»·æ ¼]
        B -->|Alice ä¸Šé™| C[2200 USDC]
    end
    
    subgraph "Tick æ˜ å°„"
        T1[tick: 75060] --> T2[tick: 76318<br/>â­å½“å‰]
        T2 --> T3[tick: 77640]
    end
    
    subgraph "æµåŠ¨æ€§çŠ¶æ€"
        L1[æµåŠ¨æ€§: 0] -.->|æ·»åŠ å| L2[æµåŠ¨æ€§: 1,000,000]
    end
    
    style B fill:#ffd54f
    style T2 fill:#ffd54f
    style L2 fill:#c8e6c9
```

#### æ“ä½œ

```solidity
// Alice åœ¨ä»·æ ¼åŒºé—´ [1800, 2200] æ·»åŠ æµåŠ¨æ€§
// tick = 75054 (price=1800), tick = 77622 (price=2200)
// liquidity = 1,000,000

alice.mint(
    recipient: Alice,
    tickLower: 75060,  // å¯¹é½åˆ° tickSpacing=60
    tickUpper: 77640,
    amount: 1000000
);
```

#### è®¡ç®—æ‰€éœ€ä»£å¸

å½“å‰ä»·æ ¼ 2000 åœ¨åŒºé—´å†…ï¼Œéœ€è¦ä¸¤ç§ä»£å¸ï¼š

```
amount0 (USDC) = L * (1/sqrt(P) - 1/sqrt(Pb))
               = 1000000 * (1/âˆš2000 - 1/âˆš2200)
               = 1000000 * (0.02236 - 0.02132)
               = 1040 USDC

amount1 (ETH) = L * (sqrt(P) - sqrt(Pa))
              = 1000000 * (âˆš2000 - âˆš1800)
              = 1000000 * (44.72 - 42.43)
              = 2.29 ETH
```

#### æ•°æ®ç»“æ„å˜åŒ–

**Position.Info[key_Alice]**:

```
key = keccak256(Alice, 75060, 77640)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liquidity: 1,000,000                             â”‚
â”‚ feeGrowthInside0LastX128: 0                      â”‚
â”‚ feeGrowthInside1LastX128: 0                      â”‚
â”‚ tokensOwed0: 0                                   â”‚
â”‚ tokensOwed1: 0                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tick.Info[75060]** (ä¸‹é™):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liquidityGross: 1,000,000                        â”‚
â”‚ liquidityNet: +1,000,000  (ä»·æ ¼ä¸Šå‡æ—¶æ¿€æ´»)      â”‚
â”‚ feeGrowthOutside0X128: 0                         â”‚
â”‚ feeGrowthOutside1X128: 0                         â”‚
â”‚ tickCumulativeOutside: 0                         â”‚
â”‚ secondsPerLiquidityOutsideX128: 0                â”‚
â”‚ secondsOutside: 0                                â”‚
â”‚ initialized: true                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tick.Info[77640]** (ä¸Šé™):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liquidityGross: 1,000,000                        â”‚
â”‚ liquidityNet: -1,000,000  (ä»·æ ¼ä¸Šå‡æ—¶å¤±æ´»)      â”‚
â”‚ feeGrowthOutside0X128: 0                         â”‚
â”‚ feeGrowthOutside1X128: 0                         â”‚
â”‚ tickCumulativeOutside: 0                         â”‚
â”‚ secondsPerLiquidityOutsideX128: 0                â”‚
â”‚ secondsOutside: 0                                â”‚
â”‚ initialized: true                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TickBitmap** (ä½å›¾æ›´æ–°):

```
wordPos = 75060 >> 8 = 293
bitPos = 75060 % 256 = 36

tickBitmap[293] |= (1 << 36)  // è®¾ç½®ç¬¬ 36 ä½

wordPos = 77640 >> 8 = 303
bitPos = 77640 % 256 = 72

tickBitmap[303] |= (1 << 72)  // è®¾ç½®ç¬¬ 72 ä½
```

**Slot0** (å…¨å±€æµåŠ¨æ€§æ›´æ–°):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liquidity: 1,000,000  (ä» 0 å¢åŠ åˆ° 1M)          â”‚
â”‚ (å…¶ä»–å­—æ®µä¸å˜)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### åœºæ™¯ 3ï¼šBob æ·»åŠ é‡å æµåŠ¨æ€§

#### æµåŠ¨æ€§å åŠ ç¤ºæ„å›¾

```mermaid
graph TB
    subgraph "ä»·æ ¼åŒºé—´åˆ†å¸ƒ"
        P1[1800] --> P2[1900] --> P3[2000â­] --> P4[2100] --> P5[2200]
    end
    
    subgraph "Alice çš„æµåŠ¨æ€§"
        A1[75060] ---|1,000,000| A2[77640]
    end
    
    subgraph "Bob çš„æµåŠ¨æ€§"
        B1[75900] ---|500,000| B2[77280]
    end
    
    subgraph "æ´»è·ƒæµåŠ¨æ€§åˆ†å¸ƒ"
        direction LR
        Z1["< 75060<br/>0"] --> Z2["75060-75900<br/>1,000,000"]
        Z2 --> Z3["75900-77280<br/>1,500,000<br/>â­å½“å‰"]
        Z3 --> Z4["77280-77640<br/>1,000,000"]
        Z4 --> Z5["> 77640<br/>0"]
    end
    
    style P3 fill:#ffd54f
    style Z3 fill:#ffd54f
```

#### æµåŠ¨æ€§å˜åŒ–æ—¶é—´çº¿

```mermaid
timeline
    title æµåŠ¨æ€§å˜åŒ–å†å²
    åˆå§‹åŒ– : å…¨å±€æµåŠ¨æ€§ = 0
    Alice mint : åŒºé—´ [75060, 77640]
              : æ´»è·ƒæµåŠ¨æ€§ = 1,000,000
    Bob mint : åŒºé—´ [75900, 77280]
             : æ´»è·ƒæµåŠ¨æ€§ = 1,500,000
             : (å½“å‰ä»·æ ¼åœ¨é‡å åŒº)
```

#### æ“ä½œ

```solidity
// Bob åœ¨ä»·æ ¼åŒºé—´ [1900, 2100] æ·»åŠ æµåŠ¨æ€§
// liquidity = 500,000

bob.mint(
    recipient: Bob,
    tickLower: 75900,
    tickUpper: 77280,
    amount: 500000
);
```

#### æ•°æ®ç»“æ„å˜åŒ–

**Position.Info[key_Bob]**:

```
key = keccak256(Bob, 75900, 77280)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liquidity: 500,000                               â”‚
â”‚ feeGrowthInside0LastX128: 0                      â”‚
â”‚ feeGrowthInside1LastX128: 0                      â”‚
â”‚ tokensOwed0: 0                                   â”‚
â”‚ tokensOwed1: 0                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tick.Info[75900]** (Bob çš„ä¸‹é™):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liquidityGross: 500,000                          â”‚
â”‚ liquidityNet: +500,000                           â”‚
â”‚ (å…¶ä»–å­—æ®µåˆå§‹åŒ–ä¸º 0)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tick.Info[77280]** (Bob çš„ä¸Šé™):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liquidityGross: 500,000                          â”‚
â”‚ liquidityNet: -500,000                           â”‚
â”‚ (å…¶ä»–å­—æ®µåˆå§‹åŒ–ä¸º 0)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…¨å±€æµåŠ¨æ€§**:

```
å½“å‰ tick = 76318 (ä»·æ ¼ 2000)
Bob çš„åŒºé—´åŒ…å«å½“å‰ä»·æ ¼

liquidity: 1,000,000 + 500,000 = 1,500,000
```

**æµåŠ¨æ€§åˆ†å¸ƒå›¾**:

```
ä»·æ ¼è½´:  1800      1900      2000      2100      2200
       â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€>
Tick:  75060     75900     76318     77280     77640

Alice: [â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•]  1M
Bob:              [â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•]          500K

æ´»è·ƒæµåŠ¨æ€§:
  < 75060:         0
  75060-75900:     1,000,000
  75900-77280:     1,500,000  â† å½“å‰ä»·æ ¼åœ¨æ­¤åŒºé—´
  77280-77640:     1,000,000
  > 77640:         0
```

---

### åœºæ™¯ 4ï¼šç”¨æˆ·äº¤æ˜“ (ä¹°å…¥ ETH)

#### äº¤æ˜“æµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼€å§‹ Swap] --> B{æ£€æŸ¥é‡å…¥é”}
    B -->|unlocked=true| C[é”å®š: unlocked=false]
    B -->|å·²é”å®š| X[âŒ å¤±è´¥]
    
    C --> D[è¯»å– Slot0<br/>price=2000, L=1.5M]
    D --> E[è®¡ç®—äº¤æ˜“è´¹ç”¨<br/>fee = 3 USDC]
    E --> F[å®é™…äº¤æ˜“é‡<br/>997 USDC]
    
    F --> G[ä½¿ç”¨ SwapMath<br/>è®¡ç®—æ–°ä»·æ ¼]
    G --> H[æ–°ä»·æ ¼: 1887 USDC/ETH<br/>æ–°tick: 75567]
    
    H --> I[æ›´æ–° feeGrowthGlobal<br/>+= fee/liquidity]
    I --> J[æ›´æ–° Slot0<br/>æ–°ä»·æ ¼å’Œtick]
    J --> K[å†™å…¥ Oracle]
    
    K --> L[è½¬è´¦ 0.512 ETH ç»™ç”¨æˆ·]
    L --> M[éªŒè¯ USDC ä½™é¢]
    M --> N[è§£é”: unlocked=true]
    N --> O[âœ“ å®Œæˆ]
    
    style A fill:#e1f5ff
    style O fill:#c8e6c9
    style X fill:#ffcdd2
```

#### ä»·æ ¼å˜åŒ–ç¤ºæ„å›¾

```mermaid
graph LR
    subgraph "äº¤æ˜“å‰"
        P1[ä»·æ ¼: 2000 USDC/ETH]
        T1[tick: 76318]
        L1[æµåŠ¨æ€§: 1,500,000]
    end
    
    subgraph "äº¤æ˜“è¿‡ç¨‹"
        direction TB
        S1[è¾“å…¥: 1000 USDC] --> S2[è´¹ç”¨: 3 USDC]
        S2 --> S3[å®é™…: 997 USDC]
        S3 --> S4[è¾“å‡º: 0.512 ETH]
    end
    
    subgraph "äº¤æ˜“å"
        P2[ä»·æ ¼: 1887 USDC/ETH]
        T2[tick: 75567]
        L2[æµåŠ¨æ€§: 1,500,000]
    end
    
    P1 -.->|ä»·æ ¼ä¸‹è·Œ| P2
    T1 -.->|tick ä¸‹é™| T2
    
    style S1 fill:#e1f5ff
    style S4 fill:#c8e6c9
```

#### è´¹ç”¨ç´¯ç§¯æœºåˆ¶å›¾

```mermaid
graph TD
    subgraph "è´¹ç”¨åˆ†é…"
        F1[äº¤æ˜“è´¹: 3 USDC] --> F2{åè®®è´¹å¯ç”¨?}
        F2 -->|å¦| F3[LPè´¹ç”¨: 3 USDC]
        F2 -->|æ˜¯| F4[åè®®è´¹]
        F2 -->|æ˜¯| F5[LPè´¹ç”¨]
    end
    
    subgraph "è´¹ç”¨å¢é•¿æ›´æ–°"
        F3 --> G1[feeGrowthGlobal0X128<br/>+= 3 * 2^128 / 1,500,000]
        G1 --> G2[= 6.8e32]
    end
    
    subgraph "LP è·å¾—è´¹ç”¨"
        G2 --> LP1[Alice åŒºé—´å†…<br/>è·å¾—éƒ¨åˆ†è´¹ç”¨]
        G2 --> LP2[Bob åŒºé—´å†…<br/>è·å¾—éƒ¨åˆ†è´¹ç”¨]
    end
    
    style F1 fill:#fff9c4
    style LP1 fill:#c8e6c9
    style LP2 fill:#c8e6c9
```

#### æ“ä½œ

```solidity
// ç”¨æˆ·ç”¨ 1000 USDC ä¹° ETH
trader.swap(
    recipient: Trader,
    zeroForOne: true,  // USDC â†’ ETH
    amountSpecified: 1000e6,  // 1000 USDC
    sqrtPriceLimitX96: 0
);
```

#### äº¤æ˜“è¿‡ç¨‹åˆ†æ

**æ­¥éª¤ 1: åˆå§‹çŠ¶æ€**

```
å½“å‰ä»·æ ¼: 2000 USDC/ETH
å½“å‰æµåŠ¨æ€§: 1,500,000
è¾“å…¥: 1000 USDC
```

**æ­¥éª¤ 2: è®¡ç®—äº¤æ˜“è´¹ç”¨**

```
fee = 1000 * 0.003 = 3 USDC
å®é™…ç”¨äºäº¤æ˜“çš„ USDC = 997 USDC
```

**æ­¥éª¤ 3: è®¡ç®—æ–°ä»·æ ¼å’Œè¾“å‡º**

```
ä½¿ç”¨ SwapMath.computeSwapStep():

Î”(1/âˆšP) = 997 / 1,500,000 = 0.000665

1/âˆšP_new = 1/âˆš2000 + 0.000665
         = 0.02236 + 0.000665
         = 0.02302

âˆšP_new = 43.44
P_new = 1887 USDC/ETH

ETH è¾“å‡º = L * Î”âˆšP
         = 1,500,000 * (44.72 - 43.44)
         = 1,500,000 * 1.28
         = 0.512 ETH
```

**æ­¥éª¤ 4: æ›´æ–°è´¹ç”¨å¢é•¿**

```
feeGrowthGlobal0X128 += (3 * 2^128) / 1,500,000
                      = (3 * 3.4e38) / 1,500,000
                      = 6.8e32
```

#### æ•°æ®ç»“æ„å˜åŒ–

**Slot0** (ä»·æ ¼å’Œ tick æ›´æ–°):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sqrtPriceX96:  3442899871234567890123456789000  â”‚
â”‚ tick:          75567  (ä» 76318 ä¸‹é™)           â”‚
â”‚ observationIndex: 0                              â”‚
â”‚ (å…¶ä»–å­—æ®µä¸å˜)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…¨å±€çŠ¶æ€**:

```
feeGrowthGlobal0X128: 0 + 6.8e32 = 6.8e32
feeGrowthGlobal1X128: 0 (æ²¡æœ‰ ETH ä½œä¸ºè¾“å…¥)
liquidity: 1,500,000 (ä¸å˜ï¼Œæœªè·¨è¶Š tick)
```

**Oracle.Observation** (å¦‚æœè¿‡äº†ä¸€æ®µæ—¶é—´):

```
å‡è®¾è·ç¦»åˆå§‹åŒ–è¿‡äº† 3600 ç§’

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ blockTimestamp: 1705318800 (+3600 ç§’)           â”‚
â”‚ tickCumulative: 76318 * 3600 = 274,744,800      â”‚
â”‚ secondsPerLiquidityX128:                         â”‚
â”‚   (3600 * 2^128) / 1,500,000 = 8.16e32          â”‚
â”‚ initialized: true                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Position æ•°æ®** (å°šæœªæ›´æ–°ï¼Œç­‰å¾…ä¸‹æ¬¡ä¿®æ”¹):

```
Alice å’Œ Bob çš„ Position.Info æš‚æ—¶ä¸å˜
ä½†ä»–ä»¬å·²ç»ç´¯ç§¯äº†è´¹ç”¨ï¼
```

---

### åœºæ™¯ 5ï¼šè·¨è¶Š Tick çš„å¤§é¢äº¤æ˜“

#### Tick è·¨è¶Šæµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼€å§‹å¤§é¢äº¤æ˜“<br/>5000 USDC] --> B[å½“å‰çŠ¶æ€<br/>tick: 75567<br/>L: 1.5M]
    
    B --> C{ä½¿ç”¨ TickBitmap<br/>æŸ¥æ‰¾ä¸‹ä¸€ä¸ª tick}
    C --> D[æ‰¾åˆ°: tick 75900<br/>Bobçš„ä¸‹é™]
    
    D --> E[è®¡ç®—åˆ°è¾¾ 75900<br/>éœ€è¦ ~330 USDC]
    E --> F[æ‰§è¡Œäº¤æ˜“åˆ° 75900]
    
    F --> G[ğŸ”„ è·¨è¶Š tick 75900]
    G --> H[è°ƒç”¨ Tick.cross]
    
    H --> I[ç¿»è½¬ feeGrowthOutside]
    I --> J[æ›´æ–°æµåŠ¨æ€§<br/>L = 1.5M - 0.5M = 1M]
    
    J --> K{å‰©ä½™ USDC?}
    K -->|æ˜¯: 4670 USDC| L[ç»§ç»­ä¸‹ä¸€æ­¥äº¤æ˜“<br/>æ–°æµåŠ¨æ€§: 1M]
    K -->|å¦| M[äº¤æ˜“å®Œæˆ]
    
    L --> N[ä»·æ ¼ç»§ç»­ä¸‹è·Œ<br/>æœ€ç»ˆ tick: 74200]
    N --> M
    
    style G fill:#ff9800
    style J fill:#ffd54f
    style M fill:#c8e6c9
```

#### æµåŠ¨æ€§å˜åŒ–åŠ¨ç”»

```mermaid
stateDiagram-v2
    direction LR
    
    [*] --> çŠ¶æ€1: åˆå§‹
    çŠ¶æ€1 --> çŠ¶æ€2: äº¤æ˜“å¼€å§‹
    çŠ¶æ€2 --> çŠ¶æ€3: è·¨è¶Š tick 75900
    çŠ¶æ€3 --> [*]: äº¤æ˜“ç»“æŸ
    
    note right of çŠ¶æ€1
        tick: 75567
        price: 1887
        liquidity: 1,500,000
    end note
    
    note right of çŠ¶æ€2
        äº¤æ˜“åˆ° tick 75900
        æ¶ˆè€—: 330 USDC
        liquidity: 1,500,000
    end note
    
    note right of çŠ¶æ€3
        tick: 74200
        price: 1700
        liquidity: 1,000,000 âš ï¸
        (Bob å¤±æ´»)
    end note
```

#### Tick è·¨è¶Šè¯¦ç»†å›¾

```mermaid
graph TB
    subgraph "è·¨è¶Šå‰çŠ¶æ€"
        B1[Tick 75900<br/>liquidityNet: +500K]
        B2[feeGrowthOutside0: 0]
        B3[å½“å‰ä»·æ ¼åœ¨å³ä¾§]
    end
    
    subgraph "è·¨è¶ŠåŠ¨ä½œ"
        C1[ä»·æ ¼ä»å³å‘å·¦ç©¿è¿‡]
        C2[Tick.cross è¢«è°ƒç”¨]
    end
    
    subgraph "è·¨è¶ŠåçŠ¶æ€"
        D1[feeGrowthOutside0<br/>= global - old<br/>= 6.8e32]
        D2[æ´»è·ƒæµåŠ¨æ€§<br/>-= liquidityNet<br/>= 1.5M - 0.5M = 1M]
        D3[Bob çš„æµåŠ¨æ€§å¤±æ´»âŒ]
    end
    
    B1 --> C1
    B2 --> C2
    B3 --> C2
    C1 --> D1
    C2 --> D2
    C2 --> D3
    
    style C2 fill:#ff9800
    style D2 fill:#ffd54f
    style D3 fill:#ffcdd2
```

#### æ“ä½œ

```solidity
// å¤§é¢äº¤æ˜“ï¼š5000 USDC ä¹° ETH
// å°†ä¼šè·¨è¶Š Bob çš„ä¸‹é™ tick (75900)

trader.swap(
    recipient: Trader,
    zeroForOne: true,
    amountSpecified: 5000e6,
    sqrtPriceLimitX96: 0
);
```

#### äº¤æ˜“è¿‡ç¨‹ï¼ˆåˆ†æ­¥æ‰§è¡Œï¼‰

**åˆå§‹çŠ¶æ€**:

```
å½“å‰ tick: 75567
å½“å‰ä»·æ ¼: 1887 USDC/ETH
å½“å‰æµåŠ¨æ€§: 1,500,000
```

**æ­¥éª¤ 1: æŸ¥æ‰¾ä¸‹ä¸€ä¸ª tick**

```
ä½¿ç”¨ TickBitmap.nextInitializedTickWithinOneWord()
å‘ä¸‹æŸ¥æ‰¾: ä¸‹ä¸€ä¸ª tick = 75900 (Bob çš„ä¸‹é™)
```

**æ­¥éª¤ 2: è®¡ç®—åˆ°è¾¾ tick 75900 éœ€è¦çš„ USDC**

```
price_75900 = 1.0001^75900 â‰ˆ 1900

éœ€è¦çš„ USDC â‰ˆ 1,500,000 * (1/âˆš1887 - 1/âˆš1900)
              â‰ˆ 1,500,000 * 0.00022
              â‰ˆ 330 USDC (å«è´¹ç”¨)
```

**æ­¥éª¤ 3: è·¨è¶Š tick 75900**

è°ƒç”¨ `Tick.cross(75900)`:

```solidity
// å› ä¸ºæ˜¯å‘ä¸‹è·¨è¶Šï¼ˆä»·æ ¼ä¸‹é™ï¼‰ï¼ŒliquidityNet å–å
liquidityNet = -500,000

// æ›´æ–°æ´»è·ƒæµåŠ¨æ€§
liquidity = 1,500,000 - 500,000 = 1,000,000
```

**Tick.Info[75900] çš„å˜åŒ–**:

```
è·¨è¶Šå‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ feeGrowthOutside0X128: 0                         â”‚
â”‚ feeGrowthOutside1X128: 0                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è·¨è¶Šå (ç¿»è½¬ outside):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ feeGrowthOutside0X128:                           â”‚
â”‚   = feeGrowthGlobal0 - old_outside               â”‚
â”‚   = 6.8e32 - 0 = 6.8e32                          â”‚
â”‚ feeGrowthOutside1X128:                           â”‚
â”‚   = 0 - 0 = 0                                    â”‚
â”‚ tickCumulativeOutside: current_value             â”‚
â”‚ secondsOutside: current_seconds                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ­¥éª¤ 4: ç»§ç»­äº¤æ˜“å‰©ä½™çš„ USDC**

```
å‰©ä½™ USDC â‰ˆ 5000 - 330 = 4670 USDC
å½“å‰æµåŠ¨æ€§: 1,000,000 (å‡å°‘äº†ï¼)
ç»§ç»­è®¡ç®—ç›´åˆ° USDC è€—å°½æˆ–è¾¾åˆ°ä¸‹ä¸€ä¸ª tick
```

**æœ€ç»ˆçŠ¶æ€**:

```
æ–° tick: 74200 (å‡è®¾)
æ–°ä»·æ ¼: 1700 USDC/ETH
æ´»è·ƒæµåŠ¨æ€§: 1,000,000
```

---

### åœºæ™¯ 6ï¼šAlice æ”¶å–è´¹ç”¨

#### è´¹ç”¨è®¡ç®—æµç¨‹å›¾

```mermaid
flowchart TD
    A[Alice è°ƒç”¨ burn/collect] --> B[è¯»å–å½“å‰çŠ¶æ€]
    B --> C{å½“å‰ tick ä½ç½®?}
    
    C -->|åœ¨åŒºé—´å†…| D1[è®¡ç®— feeGrowthInside<br/>= global - below - above]
    C -->|åœ¨åŒºé—´å¤–| D2[feeGrowthInside<br/>å¯èƒ½ä¸º 0 æˆ–éƒ¨åˆ†]
    
    D1 --> E1[è´¹ç”¨ç´¯ç§¯ä¸­âœ“]
    D2 --> E2[è´¹ç”¨ä¸å†ç´¯ç§¯âŒ]
    
    E1 --> F[è®¡ç®—åº”å¾—è´¹ç”¨<br/>Î”fee * liquidity / 2^128]
    E2 --> F
    
    F --> G[æ›´æ–° tokensOwed]
    G --> H[æ›´æ–° feeGrowthInsideLast]
    H --> I{è°ƒç”¨ collect?}
    
    I -->|æ˜¯| J[è½¬è´¦ä»£å¸ç»™ Alice]
    I -->|å¦| K[è´¹ç”¨æš‚å­˜]
    
    J --> L[tokensOwed æ¸…é›¶]
    L --> M[âœ“ å®Œæˆ]
    K --> M
    
    style E1 fill:#c8e6c9
    style E2 fill:#ffcdd2
    style M fill:#c8e6c9
```

#### feeGrowthInside è®¡ç®—ç¤ºæ„å›¾

```mermaid
graph TB
    subgraph "Alice çš„åŒºé—´ [75060, 77640]"
        direction LR
        A1[75060<br/>tickLower] --> A2[å½“å‰ä»·æ ¼åŒºåŸŸ] --> A3[77640<br/>tickUpper]
    end
    
    subgraph "å½“å‰ tick = 74200 (åŒºé—´å¤–)"
        C1[ä»·æ ¼å·²ç¦»å¼€åŒºé—´]
    end
    
    subgraph "è´¹ç”¨è®¡ç®—"
        direction TB
        F1[feeGrowthGlobal<br/>å…¨å±€ç´¯ç§¯]
        F2[feeGrowthOutside[75060]<br/>ä¸‹é™å¤–éƒ¨]
        F3[feeGrowthOutside[77640]<br/>ä¸Šé™å¤–éƒ¨]
        
        F1 --> F4[feeGrowthBelow<br/>= global - outside_lower]
        F2 --> F4
        
        F3 --> F5[feeGrowthAbove<br/>= outside_upper]
        
        F4 --> F6[feeGrowthInside<br/>= global - below - above]
        F5 --> F6
    end
    
    subgraph "ç»“æœ"
        R1[åŒºé—´å†…äº§ç”Ÿçš„è´¹ç”¨<br/>å½’ Alice æ‰€æœ‰]
        R2[åŒºé—´å¤–äº§ç”Ÿçš„è´¹ç”¨<br/>ä¸å½’ Alice]
    end
    
    F6 --> R1
    C1 -.-> R2
    
    style R1 fill:#c8e6c9
    style R2 fill:#ffcdd2
```

#### è´¹ç”¨åˆ†é…æ—¶é—´çº¿

```mermaid
timeline
    title Alice è´¹ç”¨ç´¯ç§¯å†å²
    åˆå§‹åŒ– : æ·»åŠ æµåŠ¨æ€§
           : feeGrowthInsideLast = 0
    äº¤æ˜“1 (ä»·æ ¼åœ¨åŒºé—´å†…) : äº§ç”Ÿè´¹ç”¨ 3 USDC
                       : feeGrowthInside å¢åŠ 
    äº¤æ˜“2 (ä»·æ ¼åœ¨åŒºé—´å†…) : ç»§ç»­ç´¯ç§¯è´¹ç”¨
                       : Alice å¯è·å¾—è¿™éƒ¨åˆ†
    å¤§é¢äº¤æ˜“ (ä»·æ ¼ç¦»å¼€åŒºé—´) : ä»·æ ¼è·Œç ´ä¸‹é™
                          : Alice æµåŠ¨æ€§å¤±æ´»
    äº¤æ˜“3 (ä»·æ ¼åœ¨åŒºé—´å¤–) : äº§ç”Ÿçš„è´¹ç”¨ä¸å½’ Alice
                       : feeGrowthInside ä¸å˜
    Alice collect : æ”¶å–ç´¯ç§¯çš„è´¹ç”¨
                  : æ›´æ–° feeGrowthInsideLast
```

#### æ“ä½œ

```solidity
// Alice æ›´æ–°å¤´å¯¸å¹¶æ”¶å–ç´¯ç§¯çš„è´¹ç”¨
alice.burn(0);  // burn 0 æµåŠ¨æ€§ï¼Œåªæ˜¯è§¦å‘è´¹ç”¨è®¡ç®—
alice.collect();
```

#### è´¹ç”¨è®¡ç®—è¿‡ç¨‹

**æ­¥éª¤ 1: è®¡ç®— feeGrowthInside**

Alice çš„åŒºé—´ï¼š[75060, 77640]
å½“å‰ tickï¼š74200 (åœ¨åŒºé—´å¤–)

```solidity
// Below: tick 75060
feeGrowthBelow0 = (74200 >= 75060) 
    ? feeGrowthOutside[75060]
    : feeGrowthGlobal0 - feeGrowthOutside[75060]
    = feeGrowthGlobal0 - 0  (å½“å‰ tick < 75060)
    = å½“å‰ç´¯ç§¯å€¼

// Above: tick 77640
feeGrowthAbove0 = (74200 < 77640)
    ? feeGrowthOutside[77640]
    : feeGrowthGlobal0 - feeGrowthOutside[77640]
    = 0  (tick 77640 ä»æœªè·¨è¶Š)

// Inside
feeGrowthInside0 = feeGrowthGlobal0 - feeGrowthBelow0 - feeGrowthAbove0
                 = feeGrowthGlobal0 - feeGrowthGlobal0 - 0
                 = 0  (ä»·æ ¼åœ¨åŒºé—´å¤–ï¼Œæ²¡æœ‰è´¹ç”¨ï¼)
```

**å®é™…æƒ…å†µ**:

```
å› ä¸ºå½“å‰ä»·æ ¼å·²ç»ç¦»å¼€äº† Alice çš„åŒºé—´ï¼Œ
å¥¹çš„æµåŠ¨æ€§ä¸å†æ´»è·ƒï¼Œ
æ‰€ä»¥åœ¨ä»·æ ¼åŒºé—´å¤–æœŸé—´çš„è´¹ç”¨ä¸å½’å¥¹ã€‚

ä½†åœ¨ä»·æ ¼è¿˜åœ¨åŒºé—´å†…æ—¶äº§ç”Ÿçš„è´¹ç”¨ (åœºæ™¯ 4) å½’å¥¹ï¼
```

**æ­¥éª¤ 2: è®¡ç®—ç´¯ç§¯è´¹ç”¨**

å‡è®¾ä»·æ ¼åœ¨ Alice åŒºé—´å†…æ—¶ï¼Œ`feeGrowthInside` å¢é•¿äº† `Î”feeGrowth`ï¼š

```solidity
fees0 = (feeGrowthInside0 - feeGrowthInside0Last) 
        * liquidity / 2^128
      = Î”feeGrowth * 1,000,000 / 2^128
      â‰ˆ å®é™…è´¹ç”¨é‡‘é¢
```

#### Position.Info[key_Alice] æ›´æ–°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liquidity: 1,000,000 (ä¸å˜)                      â”‚
â”‚ feeGrowthInside0LastX128: æ›´æ–°ä¸ºå½“å‰å€¼           â”‚
â”‚ feeGrowthInside1LastX128: æ›´æ–°ä¸ºå½“å‰å€¼           â”‚
â”‚ tokensOwed0: ç´¯ç§¯çš„ USDC è´¹ç”¨                    â”‚
â”‚ tokensOwed1: ç´¯ç§¯çš„ ETH è´¹ç”¨                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### åœºæ™¯ 7ï¼šåè®®è´¹å¯ç”¨

#### åè®®è´¹è®¾ç½®æµç¨‹

```mermaid
flowchart LR
    A[Factory Owner] --> B[setFeeProtocol]
    B --> C{éªŒè¯æƒé™}
    C -->|âœ“ æ˜¯ owner| D[è®¾ç½® feeProtocol]
    C -->|âœ— ä¸æ˜¯| X[âŒ æ‹’ç»]
    
    D --> E[token0 rate = 5<br/>1/5 = 20%]
    D --> F[token1 rate = 4<br/>1/4 = 25%]
    
    E --> G[ä½æ‰“åŒ…<br/>5 + 4<<4 = 69]
    F --> G
    
    G --> H[æ›´æ–° Slot0.feeProtocol]
    H --> I[âœ“ ç”Ÿæ•ˆ]
    
    style A fill:#e1f5ff
    style I fill:#c8e6c9
    style X fill:#ffcdd2
```

#### feeProtocol ä½æ‰“åŒ…å›¾

```mermaid
graph TB
    subgraph "feeProtocol = 69 (uint8)"
        direction LR
        B1["é«˜4ä½<br/>0100<br/>(4)"] --- B2["ä½4ä½<br/>0101<br/>(5)"]
    end
    
    subgraph "è§£æ"
        P1[token1 è´¹ç‡<br/>= 69 >> 4<br/>= 4<br/>= 25%]
        P2[token0 è´¹ç‡<br/>= 69 % 16<br/>= 5<br/>= 20%]
    end
    
    B1 --> P1
    B2 --> P2
    
    style B1 fill:#bbdefb
    style B2 fill:#c5e1a5
```

#### è´¹ç”¨åˆ†é…å¯¹æ¯”å›¾

```mermaid
graph TB
    subgraph "äº¤æ˜“äº§ç”Ÿ 10 USDC è´¹ç”¨"
        F[10 USDC]
    end
    
    subgraph "åè®®è´¹å…³é—­"
        F --> N1[LP è·å¾—: 10 USDC]
        F --> N2[åè®®è·å¾—: 0 USDC]
    end
    
    subgraph "åè®®è´¹å¼€å¯ (20%)"
        F --> Y1[åè®®è´¹: 10/5 = 2 USDC]
        F --> Y2[LP è´¹ç”¨: 10-2 = 8 USDC]
    end
    
    subgraph "æ•°æ®æ›´æ–°"
        Y1 --> U1[protocolFees.token0 += 2]
        Y2 --> U2[feeGrowthGlobal0X128<br/>+= 8*2^128/L]
    end
    
    style N1 fill:#c8e6c9
    style Y1 fill:#fff9c4
    style Y2 fill:#c8e6c9
```

#### åè®®è´¹æ”¶å–æµç¨‹

```mermaid
sequenceDiagram
    participant Trader as äº¤æ˜“è€…
    participant Pool as æ± åˆçº¦
    participant Protocol as åè®®
    participant LPs as æµåŠ¨æ€§æä¾›è€…
    
    Trader->>Pool: swap (äº¤æ˜“è´¹ 10 USDC)
    
    Pool->>Pool: æ£€æŸ¥ feeProtocol
    
    alt åè®®è´¹å¼€å¯
        Pool->>Protocol: protocolFees += 2 USDC (20%)
        Pool->>LPs: feeGrowth += 8 USDC (80%)
    else åè®®è´¹å…³é—­
        Pool->>LPs: feeGrowth += 10 USDC (100%)
    end
    
    Note over Protocol: Factory Owner<br/>å¯è°ƒç”¨ collectProtocol
    
    Protocol->>Pool: collectProtocol()
    Pool-->>Protocol: è½¬è´¦ç´¯ç§¯çš„åè®®è´¹
```

#### æ“ä½œ

```solidity
// Factory owner å¯ç”¨åè®®è´¹
// token0 åè®®è´¹ = 5 (20%), token1 = 4 (25%)
factory.setFeeProtocol(pool, 5, 4);
```

#### æ•°æ®ç»“æ„å˜åŒ–

**Slot0**:

```
feeProtocol è®¡ç®—:
= 5 + (4 << 4)
= 5 + 64
= 69

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ feeProtocol: 69                                  â”‚
â”‚   è§£æ: token0 = 69 % 16 = 5 (1/5 = 20%)        â”‚
â”‚        token1 = 69 >> 4 = 4 (1/4 = 25%)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åç»­äº¤æ˜“ä¸­çš„è´¹ç”¨åˆ†é…**:

å‡è®¾ä¸‹ä¸€ç¬”äº¤æ˜“äº§ç”Ÿ 10 USDC è´¹ç”¨ï¼š

```
åè®®è´¹ = 10 / 5 = 2 USDC
LP è´¹ç”¨ = 10 - 2 = 8 USDC

protocolFees.token0 += 2
feeGrowthGlobal0 += (8 * 2^128) / liquidity
```

---

### åœºæ™¯ 8ï¼šé¢„è¨€æœºæŸ¥è¯¢ TWAP

#### Oracle æŸ¥è¯¢æµç¨‹å›¾

```mermaid
flowchart TD
    A[ç”¨æˆ·æŸ¥è¯¢ TWAP] --> B[è¾“å…¥æ—¶é—´ç‚¹<br/>3600ç§’å‰ & ç°åœ¨]
    
    B --> C[observe å‡½æ•°]
    C --> D{æŸ¥è¯¢ç±»å‹}
    
    D -->|å•ç‚¹æŸ¥è¯¢| E1[observeSingle]
    D -->|å¤šç‚¹æŸ¥è¯¢| E2[æ‰¹é‡ observeSingle]
    
    E1 --> F{æ•°æ®æ˜¯å¦å­˜åœ¨?}
    E2 --> F
    
    F -->|ç²¾ç¡®åŒ¹é…| G1[ç›´æ¥è¿”å› Observation]
    F -->|éœ€è¦æ’å€¼| G2[getSurroundingObservations]
    
    G2 --> H[äºŒåˆ†æŸ¥æ‰¾<br/>binarySearch]
    H --> I[æ‰¾åˆ°å‰åä¸¤ä¸ªè§‚å¯Ÿ]
    
    I --> J[çº¿æ€§æ’å€¼è®¡ç®—<br/>tickCumulative]
    
    G1 --> K[è¿”å›ç»“æœ]
    J --> K
    
    K --> L[è®¡ç®— TWAP<br/>Î”cumulative / Î”time]
    
    style A fill:#e1f5ff
    style L fill:#c8e6c9
```

#### Oracle å­˜å‚¨ç»“æ„å›¾

```mermaid
graph TB
    subgraph "Observations ç¯å½¢æ•°ç»„"
        direction LR
        O0[0: T0] --> O1[1: T1]
        O1 --> O2[2: T2]
        O2 --> O3[...]
        O3 --> O4["index<br/>(æœ€æ–°)"]
        O4 -.->|ç¯å½¢| O0
    end
    
    subgraph "Slot0 æŒ‡é’ˆ"
        S1[observationIndex: 4]
        S2[observationCardinality: 100]
        S3[observationCardinalityNext: 100]
    end
    
    subgraph "å•ä¸ª Observation"
        OB1[blockTimestamp: uint32]
        OB2[tickCumulative: int56]
        OB3[secondsPerLiquidityX128]
        OB4[initialized: bool]
    end
    
    S1 --> O4
    O4 --> OB1
    
    style O4 fill:#ffd54f
    style S1 fill:#ffd54f
```

#### TWAP è®¡ç®—ç¤ºæ„å›¾

```mermaid
graph LR
    subgraph "æ—¶é—´ T0 (1å°æ—¶å‰)"
        T0[timestamp: 1705315200]
        TC0[tickCumulative: 274,744,800]
        P0[tick: ~76318<br/>price: ~2000]
    end
    
    subgraph "æ—¶é—´ T1 (ç°åœ¨)"
        T1[timestamp: 1705318800]
        TC1[tickCumulative: 540,000,000]
        P1[tick: ~74200<br/>price: ~1700]
    end
    
    subgraph "TWAP è®¡ç®—"
        direction TB
        C1[Î”cumulative<br/>= 540M - 274.7M<br/>= 265.3M]
        C2[Î”time<br/>= 3600 ç§’]
        C3[TWAP tick<br/>= 265.3M / 3600<br/>= 73,681]
        C4[å¹³å‡ä»·æ ¼<br/>= 1.0001^73681<br/>â‰ˆ 1950 USDC/ETH]
        
        C1 --> C3
        C2 --> C3
        C3 --> C4
    end
    
    TC0 --> C1
    TC1 --> C1
    T0 --> C2
    T1 --> C2
    
    style C4 fill:#c8e6c9
```

#### ä»·æ ¼å˜åŒ–æ—¶é—´åºåˆ—å›¾

```mermaid
graph TD
    subgraph "ä»·æ ¼å†å² (1å°æ—¶å†…)"
        direction LR
        P1["T0: 2000"] -->|ä¸‹è·Œ| P2["T0+15min: 1950"]
        P2 -->|ä¸‹è·Œ| P3["T0+30min: 1900"]
        P3 -->|ä¸‹è·Œ| P4["T0+45min: 1800"]
        P4 -->|ä¸‹è·Œ| P5["T1: 1700"]
    end
    
    subgraph "ç´¯ç§¯å€¼å¢é•¿"
        direction TB
        A1[tickCumulative æŒç»­å¢é•¿]
        A2[æ–œç‡ = å½“å‰ tick]
        A3[TWAP = å¹³å‡æ–œç‡]
    end
    
    subgraph "ä¼˜åŠ¿"
        B1[âœ“ æŠ—æ“çºµ]
        B2[âœ“ æ—¶é—´åŠ æƒ]
        B3[âœ“ é“¾ä¸Šå¯éªŒè¯]
    end
    
    style P1 fill:#c8e6c9
    style P5 fill:#ffcdd2
    style B1 fill:#c8e6c9
    style B2 fill:#c8e6c9
    style B3 fill:#c8e6c9
```

#### äºŒåˆ†æŸ¥æ‰¾è¿‡ç¨‹å›¾

```mermaid
flowchart TD
    A[æŸ¥è¯¢ 3600ç§’å‰æ•°æ®] --> B[å¼€å§‹äºŒåˆ†æŸ¥æ‰¾]
    
    B --> C{æ£€æŸ¥å·¦è¾¹ç•Œ}
    C -->|åŒ¹é…| R1[è¿”å›å·¦è§‚å¯Ÿ]
    C -->|ä¸åŒ¹é…| D{æ£€æŸ¥å³è¾¹ç•Œ}
    
    D -->|åŒ¹é…| R2[è¿”å›å³è§‚å¯Ÿ]
    D -->|ä¸åŒ¹é…| E[è®¡ç®—ä¸­ç‚¹<br/>mid = left + right / 2]
    
    E --> F{mid æ—¶é—´ vs ç›®æ ‡æ—¶é—´}
    
    F -->|mid < target| G[left = mid + 1]
    F -->|mid >= target| H[right = mid - 1]
    
    G --> I{left <= right?}
    H --> I
    
    I -->|æ˜¯| E
    I -->|å¦| J[æ‰¾åˆ°å‰åä¸¤ä¸ªè§‚å¯Ÿ]
    
    J --> K[çº¿æ€§æ’å€¼]
    K --> L[è¿”å›æ’å€¼ç»“æœ]
    
    style A fill:#e1f5ff
    style L fill:#c8e6c9
    style R1 fill:#c8e6c9
    style R2 fill:#c8e6c9
```

#### æ“ä½œ

```solidity
// æŸ¥è¯¢è¿‡å» 1 å°æ—¶çš„ TWAP
uint32[] memory secondsAgos = new uint32[](2);
secondsAgos[0] = 3600;  // 1 å°æ—¶å‰
secondsAgos[1] = 0;     // ç°åœ¨

(int56[] memory tickCumulatives, ) = pool.observe(secondsAgos);
```

#### è®¡ç®—è¿‡ç¨‹

**Observation å†å²æ•°æ®**:

```
æ—¶åˆ» T0 (1 å°æ—¶å‰):
  blockTimestamp: 1705315200
  tickCumulative: 274,744,800
  tick å¹³å‡å€¼: â‰ˆ 76318

æ—¶åˆ» T1 (ç°åœ¨):
  blockTimestamp: 1705318800
  tickCumulative: 540,000,000
  tick å˜åŒ–: ä»·æ ¼ä¸‹è·Œäº†
```

**TWAP è®¡ç®—**:

```
TWAP tick = (tickCumulative[T1] - tickCumulative[T0]) 
            / (T1 - T0)
          = (540,000,000 - 274,744,800) / 3600
          = 73,681

å¹³å‡ä»·æ ¼ = 1.0001^73681 â‰ˆ 1950 USDC/ETH
```

---

### åœºæ™¯æ€»ç»“ï¼šæ•°æ®ç»“æ„äº¤äº’å›¾

#### å®Œæ•´çš„æ“ä½œ-æ•°æ®ç»“æ„æ˜ å°„å›¾

```mermaid
graph TB
    subgraph "ç”¨æˆ·æ“ä½œ"
        U1[initialize]
        U2[mint]
        U3[swap]
        U4[burn]
        U5[collect]
        U6[observe]
        U7[setFeeProtocol]
    end
    
    subgraph "æ ¸å¿ƒæ•°æ®ç»“æ„"
        D1[Slot0]
        D2[Position.Info]
        D3[Tick.Info]
        D4[TickBitmap]
        D5[Oracle.Observation]
        D6[feeGrowthGlobal]
        D7[protocolFees]
    end
    
    U1 -->|å†™å…¥| D1
    U1 -->|åˆå§‹åŒ–| D5
    
    U2 -->|æ›´æ–°| D1
    U2 -->|åˆ›å»º/æ›´æ–°| D2
    U2 -->|æ›´æ–°| D3
    U2 -->|è®¾ç½®ä½| D4
    U2 -->|å¯èƒ½å†™å…¥| D5
    
    U3 -->|æ›´æ–°ä»·æ ¼| D1
    U3 -->|ç´¯ç§¯| D6
    U3 -->|ç´¯ç§¯| D7
    U3 -->|è·¨è¶Šæ—¶æ›´æ–°| D3
    U3 -->|å†™å…¥| D5
    
    U4 -->|æ›´æ–°| D2
    U4 -->|æ›´æ–°| D3
    U4 -->|å¯èƒ½æ¸…é™¤| D4
    U4 -->|æ›´æ–°æµåŠ¨æ€§| D1
    
    U5 -->|æ¸…é›¶ tokensOwed| D2
    
    U6 -.->|åªè¯»| D5
    
    U7 -->|è®¾ç½®è´¹ç‡| D1
    
    style U3 fill:#ffd54f
    style U2 fill:#c8e6c9
    style U6 fill:#e1f5ff
```

#### æ•°æ®ç»“æ„ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    A[Slot0<br/>ä¸»è¦çŠ¶æ€] -->|å½“å‰ä»·æ ¼| B[swap è®¡ç®—]
    A -->|å½“å‰ tick| C[Tick æŸ¥æ‰¾]
    A -->|æµåŠ¨æ€§| D[è´¹ç”¨è®¡ç®—]
    
    E[Tick.Info] -->|liquidityNet| F[è·¨è¶Šæ—¶è°ƒæ•´æµåŠ¨æ€§]
    E -->|feeGrowthOutside| G[è®¡ç®— feeGrowthInside]
    
    H[TickBitmap] -->|O1 æŸ¥æ‰¾| I[ä¸‹ä¸€ä¸ªåˆå§‹åŒ–çš„ tick]
    
    J[Position.Info] -->|feeGrowthInsideLast| K[è®¡ç®—æ–°å¢è´¹ç”¨]
    J -->|liquidity| K
    
    G --> K
    D --> K
    
    L[Oracle.Observation] -->|tickCumulative| M[TWAP è®¡ç®—]
    
    N[protocolFees] -->|collectProtocol| O[åè®®æ”¶å…¥]
    
    style A fill:#ff9800
    style E fill:#ffd54f
    style J fill:#c8e6c9
    style L fill:#e1f5ff
```

#### æ“ä½œé¢‘ç‡å’Œ Gas æ¶ˆè€—åˆ†æ

```mermaid
graph LR
    subgraph "é«˜é¢‘æ“ä½œ (æ¯ç¬”äº¤æ˜“)"
        H1[swap] --> G1[é«˜ Gas]
        H1 --> R1["è¯»: Slot0, Tick"]
        H1 --> W1["å†™: Slot0, Oracle, fees"]
    end
    
    subgraph "ä¸­é¢‘æ“ä½œ (LP ç®¡ç†)"
        M1[mint/burn] --> G2[ä¸­ç­‰ Gas]
        M1 --> R2["è¯»: Slot0, Tick, Position"]
        M1 --> W2["å†™: Position, Tick, Bitmap"]
    end
    
    subgraph "ä½é¢‘æ“ä½œ (æŸ¥è¯¢)"
        L1[observe] --> G3[ä½ Gas]
        L1 --> R3["åªè¯»: Oracle"]
    end
    
    subgraph "ç®¡ç†å‘˜æ“ä½œ"
        A1[setFeeProtocol] --> G4[ä½ Gas]
        A1 --> W3["å†™: Slot0.feeProtocol"]
    end
    
    style H1 fill:#ff9800
    style M1 fill:#ffd54f
    style L1 fill:#c8e6c9
    style A1 fill:#e1f5ff
```

#### çŠ¶æ€è½¬æ¢æ€»è§ˆ

```mermaid
stateDiagram-v2
    [*] --> æœªéƒ¨ç½²
    æœªéƒ¨ç½² --> å·²éƒ¨ç½²: createPool (Factory)
    å·²éƒ¨ç½² --> å·²åˆå§‹åŒ–: initialize()
    å·²åˆå§‹åŒ– --> æœ‰æµåŠ¨æ€§: mint()
    æœ‰æµåŠ¨æ€§ --> äº¤æ˜“ä¸­: swap()
    äº¤æ˜“ä¸­ --> æœ‰æµåŠ¨æ€§: äº¤æ˜“å®Œæˆ
    æœ‰æµåŠ¨æ€§ --> æµåŠ¨æ€§å‡å°‘: burn()
    æµåŠ¨æ€§å‡å°‘ --> æœ‰æµåŠ¨æ€§: å…¶ä»–LPä»æ´»è·ƒ
    æµåŠ¨æ€§å‡å°‘ --> å·²åˆå§‹åŒ–: æ‰€æœ‰æµåŠ¨æ€§ç§»é™¤
    
    æœ‰æµåŠ¨æ€§ --> æœ‰æµåŠ¨æ€§: collect() [ä¸æ”¹å˜æµåŠ¨æ€§]
    æœ‰æµåŠ¨æ€§ --> æœ‰æµåŠ¨æ€§: observe() [åªè¯»]
    æœ‰æµåŠ¨æ€§ --> æœ‰æµåŠ¨æ€§: setFeeProtocol() [åªæ”¹è´¹ç‡]
```

ä¼ ç»Ÿè¡¨æ ¼å½¢å¼ï¼š

```
ç”¨æˆ·æ“ä½œ             è§¦å‘çš„æ•°æ®ç»“æ„å˜åŒ–
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initialize()     â†’   Slot0 âœ“
                     Oracle.Observation[0] âœ“

mint()           â†’   Position.Info[key] âœ“
                     Tick.Info[lower] âœ“
                     Tick.Info[upper] âœ“
                     TickBitmap âœ“
                     Slot0.liquidity âœ“
                     Oracle (å¦‚æœ tick å˜åŒ–) âœ“

swap()           â†’   Slot0.sqrtPriceX96 âœ“
                     Slot0.tick âœ“
                     feeGrowthGlobal âœ“
                     protocolFees âœ“
                     liquidity (å¦‚æœè·¨ tick) âœ“
                     Tick.Info (å¦‚æœè·¨è¶Š) âœ“
                     Oracle âœ“

burn()           â†’   Position.Info âœ“
                     Position.tokensOwed âœ“
                     Tick.Info âœ“
                     TickBitmap (å¦‚æœæ¸…ç©º) âœ“
                     Slot0.liquidity âœ“

collect()        â†’   Position.tokensOwed â†’ 0
                     è½¬è´¦ä»£å¸ç»™ç”¨æˆ·

observe()        â†’   åªè¯»æ“ä½œï¼Œä¸ä¿®æ”¹çŠ¶æ€
```

---

### æ•°æ®ç»“æ„å…¨æ™¯å›¾

#### å®Œæ•´æ¶æ„å›¾

```mermaid
graph TB
    subgraph "UniswapV3Pool åˆçº¦"
        subgraph "ä¸»è¦çŠ¶æ€ (1 æ§½ä½)"
            S0[Slot0<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>sqrtPriceX96<br/>tick<br/>observationIndex<br/>observationCardinality<br/>feeProtocol<br/>unlocked]
        end
        
        subgraph "è´¹ç”¨è·Ÿè¸ª"
            F1[feeGrowthGlobal0X128]
            F2[feeGrowthGlobal1X128]
            F3[protocolFees<br/>token0/token1]
        end
        
        subgraph "æµåŠ¨æ€§çŠ¶æ€"
            L1[liquidity<br/>å½“å‰æ´»è·ƒæµåŠ¨æ€§]
        end
        
        subgraph "æ˜ å°„æ•°æ®ç»“æ„"
            M1[positions<br/>bytes32 => Position.Info]
            M2[ticks<br/>int24 => Tick.Info]
            M3[tickBitmap<br/>int16 => uint256]
        end
        
        subgraph "é¢„è¨€æœºæ•°ç»„"
            O1[observations<br/>Observation 65535]
        end
    end
    
    S0 -.->|æŒ‡å‘æœ€æ–°| O1
    S0 -.->|å½“å‰ tick| M2
    S0 -.->|å½“å‰æµåŠ¨æ€§| L1
    
    M1 -.->|å¼•ç”¨| M2
    M2 -.->|ç´¢å¼•| M3
    
    F1 -.->|å…¨å±€ç´¯ç§¯| M2
    F2 -.->|å…¨å±€ç´¯ç§¯| M2
    
    style S0 fill:#ff9800
    style M1 fill:#c8e6c9
    style M2 fill:#ffd54f
    style M3 fill:#e1f5ff
    style O1 fill:#ce93d8
```

#### æ•°æ®æµåŠ¨å›¾

```mermaid
flowchart LR
    subgraph "è¾“å…¥å±‚"
        I1[ç”¨æˆ·æ“ä½œ]
        I2[ä»·æ ¼å˜åŒ–]
        I3[æ—¶é—´æµé€]
    end
    
    subgraph "å¤„ç†å±‚"
        P1[Slot0<br/>çŠ¶æ€ç®¡ç†]
        P2[Tick System<br/>æµåŠ¨æ€§ç®¡ç†]
        P3[Position<br/>å¤´å¯¸ç®¡ç†]
        P4[Oracle<br/>ä»·æ ¼å†å²]
    end
    
    subgraph "è¾“å‡ºå±‚"
        O1[ä»£å¸è½¬è´¦]
        O2[è´¹ç”¨åˆ†é…]
        O3[ä»·æ ¼å‘ç°]
        O4[TWAP æ•°æ®]
    end
    
    I1 --> P1
    I1 --> P3
    I2 --> P1
    I2 --> P2
    I3 --> P4
    
    P1 --> O1
    P1 --> O3
    P2 --> O2
    P3 --> O2
    P4 --> O4
    
    P1 <--> P2
    P2 <--> P3
    P1 --> P4
    
    style P1 fill:#ff9800
    style P2 fill:#ffd54f
    style P3 fill:#c8e6c9
    style P4 fill:#ce93d8
```

#### æ•°æ®ç»“æ„å¤§å°å¯¹æ¯”

```mermaid
graph TD
    subgraph "å­˜å‚¨æˆæœ¬æ’åº"
        direction TB
        A["Slot0<br/>32 å­—èŠ‚<br/>1 æ§½ä½"]
        B["Position.Info<br/>160 å­—èŠ‚<br/>5 æ§½ä½"]
        C["Tick.Info<br/>128 å­—èŠ‚<br/>4 æ§½ä½"]
        D["Observation<br/>32 å­—èŠ‚<br/>1 æ§½ä½"]
        E["Oracle æ•°ç»„<br/>2MB<br/>65535 æ§½ä½"]
    end
    
    subgraph "Gas æˆæœ¬"
        G1["è¯»å– Slot0<br/>2,100 gas"]
        G2["è¯»å– Position<br/>10,500 gas"]
        G3["è¯»å– Tick<br/>8,400 gas"]
        G4["å†™å…¥ Tick<br/>20,000+ gas"]
    end
    
    A -.-> G1
    B -.-> G2
    C -.-> G3
    C -.-> G4
    
    style A fill:#c8e6c9
    style B fill:#fff9c4
    style C fill:#fff9c4
    style E fill:#ffcdd2
```

### å…³é”®æ´å¯Ÿ

#### 1. è´¹ç”¨åˆ†é…çš„å·§å¦™æ€§

```mermaid
graph LR
    A[äº¤æ˜“è´¹ç”¨] --> B{ä»·æ ¼åœ¨åŒºé—´å†…?}
    B -->|æ˜¯| C[feeGrowthInside å¢åŠ ]
    B -->|å¦| D[feeGrowthInside ä¸å˜]
    
    C --> E[LP è·å¾—è´¹ç”¨ âœ“]
    D --> F[LP ä¸è·å¾—è´¹ç”¨ âœ—]
    
    E -.-> G[O1 å¤æ‚åº¦è®¡ç®—]
    
    style C fill:#c8e6c9
    style D fill:#ffcdd2
    style G fill:#e1f5ff
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š

- åªæœ‰åœ¨ä»·æ ¼åŒºé—´å†…çš„æµåŠ¨æ€§æ‰èƒ½è·å¾—è´¹ç”¨
- ä½¿ç”¨ `feeGrowthInside` æœºåˆ¶ï¼ŒO(1) å¤æ‚åº¦è®¡ç®—
- å…¬å¼ï¼š`feeInside = feeGlobal - feeBelow - feeAbove`

#### 2. Tick è·¨è¶Šçš„å½±å“

```mermaid
graph TB
    A[ä»·æ ¼è·¨è¶Š Tick] --> B[è°ƒç”¨ Tick.cross]
    B --> C[ç¿»è½¬ feeGrowthOutside]
    B --> D[åº”ç”¨ liquidityNet]
    
    C --> E["outside' = global - outside"]
    D --> F["liquidity' = liquidity Â± net"]
    
    F --> G{æµåŠ¨æ€§å˜åŒ–}
    G -->|å¢åŠ | H[æ›´å¤šæµåŠ¨æ€§æ¿€æ´»]
    G -->|å‡å°‘| I[éƒ¨åˆ†æµåŠ¨æ€§å¤±æ´»]
    
    style B fill:#ff9800
    style E fill:#ffd54f
    style F fill:#ffd54f
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š

- æ¯æ¬¡è·¨è¶Šéƒ½ä¼š"ç¿»è½¬" `feeGrowthOutside` çš„å«ä¹‰
- æµåŠ¨æ€§æ ¹æ® `liquidityNet` åŠ¨æ€è°ƒæ•´
- å®ç°é›†ä¸­æµåŠ¨æ€§çš„å…³é”®

#### 3. å­˜å‚¨ä¼˜åŒ–

```mermaid
graph LR
    subgraph "æœªä¼˜åŒ–"
        U1[7 ä¸ªå˜é‡] --> U2[7 ä¸ªæ§½ä½] --> U3[14,700 gas]
    end
    
    subgraph "ä¼˜åŒ–å"
        O1[Slot0 ç»“æ„ä½“] --> O2[1 ä¸ªæ§½ä½] --> O3[2,100 gas]
    end
    
    U3 -.->|èŠ‚çœ 85%| O3
    
    style O3 fill:#c8e6c9
    style U3 fill:#ffcdd2
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š

- Slot0 æ‰“åŒ… 7 ä¸ªå˜é‡åˆ° 1 ä¸ªå­˜å‚¨æ§½
- èŠ‚çœ 85% çš„ SLOAD æˆæœ¬
- æ¯æ¬¡ swap éƒ½ä¼šè¯»å– Slot0

#### 4. é¢„è¨€æœºçš„å¯é æ€§

```mermaid
graph TD
    A[æ¯ç¬”äº¤æ˜“] --> B{åŒä¸€åŒºå—?}
    B -->|æ˜¯| C[è·³è¿‡å†™å…¥]
    B -->|å¦| D[å†™å…¥æ–°è§‚å¯Ÿ]
    
    D --> E[tickCumulative +=<br/>currentTick * Î”time]
    E --> F[ç´¯ç§¯å€¼é˜²æ“çºµ]
    
    F --> G[TWAP è®¡ç®—]
    G --> H[å¯é çš„ä»·æ ¼ä¿¡å·]
    
    style D fill:#c8e6c9
    style F fill:#c8e6c9
    style H fill:#c8e6c9
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š

- æ¯ä¸ªåŒºå—æœ€å¤šå†™å…¥ä¸€æ¬¡
- ä½¿ç”¨ç´¯ç§¯å€¼è€Œéå¿«ç…§ï¼Œé˜²æ­¢æ“çºµ
- æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ (TWAP)

#### 5. Position çš„ç‹¬ç«‹æ€§

```mermaid
graph TB
    subgraph "Alice çš„å¤´å¯¸"
        A1["key = hash(Alice, 1800, 2200)"]
        A2[ç‹¬ç«‹çš„ liquidity]
        A3[ç‹¬ç«‹çš„ fee tracking]
    end
    
    subgraph "Bob çš„å¤´å¯¸"
        B1["key = hash(Bob, 1900, 2100)"]
        B2[ç‹¬ç«‹çš„ liquidity]
        B3[ç‹¬ç«‹çš„ fee tracking]
    end
    
    subgraph "å…±äº«çš„ Tick"
        T1[Tick.Info ç´¯ç§¯]
        T2[å¤šä¸ªå¤´å¯¸å…±äº«]
    end
    
    A1 --> T1
    B1 --> T1
    
    style A1 fill:#c8e6c9
    style B1 fill:#c8e6c9
    style T1 fill:#ffd54f
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š

- æ¯ä¸ª `(owner, tickLower, tickUpper)` æ˜¯ç‹¬ç«‹çš„å¤´å¯¸
- å¯ä»¥ç²¾ç¡®è·Ÿè¸ªæ¯ä¸ª LP çš„è´¡çŒ®å’Œæ”¶ç›Š
- æ”¯æŒåŒä¸€ç”¨æˆ·åœ¨ä¸åŒåŒºé—´æä¾›å¤šä¸ªå¤´å¯¸

---

## æ€§èƒ½åˆ†æä¸æœ€ä½³å®è·µ

### Gas æˆæœ¬å¯¹æ¯”

#### ä¸åŒæ“ä½œçš„ Gas æ¶ˆè€—

```mermaid
graph TB
    subgraph "åªè¯»æ“ä½œ (ä½æˆæœ¬)"
        R1["observe()<br/>~30,000 gas"]
        R2["slot0()<br/>~2,000 gas"]
        R3["positions()<br/>~10,000 gas"]
    end
    
    subgraph "çŠ¶æ€å˜æ›´ (ä¸­ç­‰æˆæœ¬)"
        W1["collect()<br/>~50,000 gas"]
        W2["burn(å°é¢)<br/>~80,000 gas"]
    end
    
    subgraph "å¤æ‚æ“ä½œ (é«˜æˆæœ¬)"
        C1["mint(æ–°tick)<br/>~150,000+ gas"]
        C2["swap(è·¨tick)<br/>~120,000+ gas"]
        C3["mint(é¦–æ¬¡)<br/>~200,000+ gas"]
    end
    
    style R1 fill:#c8e6c9
    style R2 fill:#c8e6c9
    style R3 fill:#c8e6c9
    style W1 fill:#fff9c4
    style W2 fill:#fff9c4
    style C1 fill:#ffcdd2
    style C2 fill:#ffcdd2
    style C3 fill:#ffcdd2
```

#### å­˜å‚¨æ“ä½œæˆæœ¬ç»†åˆ†

```mermaid
pie title "å…¸å‹ swap æ“ä½œçš„ Gas åˆ†å¸ƒ"
    "SLOAD (è¯»å–çŠ¶æ€)" : 30
    "è®¡ç®— (CPU)" : 20
    "SSTORE (å†™å…¥çŠ¶æ€)" : 40
    "ä»£å¸è½¬è´¦" : 10
```

### ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”

```mermaid
graph LR
    subgraph "âŒ ä½æ•ˆæ¨¡å¼"
        B1[é¢‘ç¹å°é¢ collect] --> B2[é«˜ Gas æˆæœ¬]
        B3[è¿‡å¤šå°å¤´å¯¸] --> B4[ç®¡ç†æˆæœ¬é«˜]
        B5[çª„åŒºé—´ LP] --> B6[é¢‘ç¹å¤±æ´»]
    end
    
    subgraph "âœ“ é«˜æ•ˆæ¨¡å¼"
        G1[æ‰¹é‡ collect] --> G2[Gas èŠ‚çœ]
        G3[åˆå¹¶å¤´å¯¸] --> G4[ç®¡ç†ç®€å•]
        G5[åˆç†åŒºé—´] --> G6[æŒç»­æ”¶ç›Š]
    end
    
    style G1 fill:#c8e6c9
    style G2 fill:#c8e6c9
    style G3 fill:#c8e6c9
    style G4 fill:#c8e6c9
    style G5 fill:#c8e6c9
    style G6 fill:#c8e6c9
```

### æœ€ä½³å®è·µæµç¨‹å›¾

```mermaid
flowchart TD
    A[å‡†å¤‡æ·»åŠ æµåŠ¨æ€§] --> B{é€‰æ‹©ä»·æ ¼åŒºé—´}
    
    B --> C1[çª„åŒºé—´<br/>Â±5%]
    B --> C2[ä¸­ç­‰åŒºé—´<br/>Â±20%]
    B --> C3[å®½åŒºé—´<br/>Â±50%]
    
    C1 --> D1[âœ“ é«˜æ”¶ç›Šç‡<br/>âœ— æ˜“å¤±æ´»<br/>âœ— éœ€é¢‘ç¹è°ƒæ•´]
    C2 --> D2[âœ“ å¹³è¡¡æ”¶ç›Š<br/>âœ“ è¾ƒç¨³å®š<br/>âœ“ æ¨è]
    C3 --> D3[âœ“ å§‹ç»ˆæ´»è·ƒ<br/>âœ— ä½æ”¶ç›Šç‡<br/>âœ“ é€‚åˆè¢«åŠ¨LP]
    
    D1 --> E{Gas æˆæœ¬è€ƒè™‘}
    D2 --> E
    D3 --> E
    
    E --> F[é¦–æ¬¡ mint<br/>æˆæœ¬æœ€é«˜]
    E --> G[å¢åŠ æµåŠ¨æ€§<br/>æˆæœ¬ä¸­ç­‰]
    E --> H[collect è´¹ç”¨<br/>æˆæœ¬è¾ƒä½]
    
    F --> I[é€‰æ‹©åˆé€‚çš„<br/>åˆå§‹æµåŠ¨æ€§é‡]
    G --> I
    H --> I
    
    I --> J[âœ“ éƒ¨ç½²å¤´å¯¸]
    
    style D2 fill:#c8e6c9
    style J fill:#c8e6c9
```

### Uniswap V2 vs V3 æ•°æ®ç»“æ„å¯¹æ¯”

```mermaid
graph TB
    subgraph "Uniswap V2"
        V2_1[å•ä¸€æµåŠ¨æ€§æ± ]
        V2_2[x * y = k]
        V2_3[æ— ä»·æ ¼åŒºé—´]
        V2_4[ç®€å•ä½†ä½æ•ˆ]
    end
    
    subgraph "Uniswap V3"
        V3_1[é›†ä¸­æµåŠ¨æ€§]
        V3_2[Tick ç³»ç»Ÿ]
        V3_3[Position ç®¡ç†]
        V3_4[å¤æ‚ä½†é«˜æ•ˆ]
    end
    
    V2_1 -.->|è¿›åŒ–| V3_1
    V2_2 -.->|ä¼˜åŒ–| V3_2
    V2_3 -.->|åˆ›æ–°| V3_3
    V2_4 -.->|æ”¹è¿›| V3_4
    
    style V3_1 fill:#c8e6c9
    style V3_2 fill:#c8e6c9
    style V3_3 fill:#c8e6c9
    style V3_4 fill:#c8e6c9
```

### æ•°æ®ç»“æ„è®¾è®¡åŸåˆ™æ€»ç»“

```mermaid
mindmap
  root((Uniswap V3<br/>æ•°æ®ç»“æ„))
    æè‡´ä¼˜åŒ–
      å˜é‡æ‰“åŒ…
        Slot0 7åˆ1
        Observation 4åˆ1
      ä½æ“ä½œ
        TickBitmap
        feeProtocol
    æ•°å­¦ç²¾åº¦
      å®šç‚¹æ•°
        Q64.96 ä»·æ ¼
        Q128.128 è´¹ç”¨
      ç´¯ç§¯å€¼
        é˜²æ“çºµ
        O1 è®¡ç®—
    å®‰å…¨æ€§
      é‡å…¥ä¿æŠ¤
        unlocked
      æº¢å‡ºæ£€æŸ¥
        SafeMath
      ä½™é¢éªŒè¯
        ä¸ä¿¡ä»»è¿”å›å€¼
    å¯æ‰©å±•æ€§
      æ¨¡å—åŒ–
        ç‹¬ç«‹çš„åº“
      é¢„è¨€æœº
        65535 è§‚å¯Ÿ
      çµæ´»è´¹ç‡
        å¤šçº§åˆ«
```

### å­¦ä¹ è·¯å¾„å»ºè®®

```mermaid
journey
    title Uniswap V3 æ•°æ®ç»“æ„å­¦ä¹ è·¯å¾„
    section åŸºç¡€æ¦‚å¿µ
      ç†è§£ AMM åŸç†: 5: å­¦ä¹ è€…
      æŒæ¡å®šç‚¹æ•°: 4: å­¦ä¹ è€…
      å­¦ä¹  Solidity: 5: å­¦ä¹ è€…
    section æ ¸å¿ƒç»“æ„
      Slot0 çŠ¶æ€ç®¡ç†: 3: å­¦ä¹ è€…
      Position å¤´å¯¸: 4: å­¦ä¹ è€…
      Tick ç³»ç»Ÿ: 3: å­¦ä¹ è€…
    section é«˜çº§ä¸»é¢˜
      è´¹ç”¨ç´¯ç§¯æœºåˆ¶: 4: å­¦ä¹ è€…
      Oracle é¢„è¨€æœº: 4: å­¦ä¹ è€…
      è·¨ Tick é€»è¾‘: 5: å­¦ä¹ è€…
    section å®è·µåº”ç”¨
      éƒ¨ç½²æµ‹è¯•æ± : 5: å­¦ä¹ è€…
      é›†æˆåˆ° DApp: 5: å­¦ä¹ è€…
      ä¼˜åŒ– Gas æˆæœ¬: 5: å­¦ä¹ è€…
```

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å…¬å¼é€ŸæŸ¥

```mermaid
graph TD
    subgraph "ä»·æ ¼è®¡ç®—"
        P1["price = 1.0001^tick"]
        P2["sqrtPrice = sqrt(price) * 2^96"]
    end
    
    subgraph "æµåŠ¨æ€§è®¡ç®—"
        L1["L = Î”y / Î”âˆšP"]
        L2["L = Î”x * âˆšP * âˆšPb / (âˆšPb - âˆšP)"]
    end
    
    subgraph "è´¹ç”¨è®¡ç®—"
        F1["feeGrowth += fee * 2^128 / L"]
        F2["feeEarned = Î”feeGrowth * L / 2^128"]
    end
    
    subgraph "TWAP è®¡ç®—"
        T1["TWAP = Î”tickCumulative / Î”time"]
        T2["avgPrice = 1.0001^TWAP"]
    end
    
    style P1 fill:#e1f5ff
    style L1 fill:#fff9c4
    style F1 fill:#c8e6c9
    style T1 fill:#ce93d8
```

### å…³é”®å¸¸é‡

| å¸¸é‡ | å€¼ | å«ä¹‰ |
|------|-----|------|
| Q96 | 2^96 | ä»·æ ¼å®šç‚¹æ•°åŸºæ•° |
| Q128 | 2^128 | è´¹ç”¨å®šç‚¹æ•°åŸºæ•° |
| MIN_TICK | -887,272 | æœ€å° tick |
| MAX_TICK | 887,272 | æœ€å¤§ tick |
| MIN_SQRT_RATIO | 4,295,128,739 | æœ€å°ä»·æ ¼ |
| MAX_SQRT_RATIO | 1,461,446,703,485,210,103,287,273,052,203,988,822,378,723,970,342 | æœ€å¤§ä»·æ ¼ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç”Ÿæˆæ—¶é—´**: 2026-01-15  
**é€‚ç”¨äº**: Uniswap V3 Core  
**Solidity ç‰ˆæœ¬**: 0.7.6  

ğŸ‰ è¿™ä»½æ–‡æ¡£æ·±å…¥åˆ†æäº† Uniswap V3 çš„æ‰€æœ‰æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ŒåŒ…å« 30+ Mermaid å›¾è¡¨ï¼Œå¸®åŠ©æ‚¨å…¨é¢ç†è§£åè®®çš„åº•å±‚è®¾è®¡ï¼

---

## å›¾è¡¨ç´¢å¼•

æœ¬æ–‡æ¡£åŒ…å«ä»¥ä¸‹ç±»å‹çš„ Mermaid å›¾è¡¨ï¼š

- **æµç¨‹å›¾ (Flowchart)**: 8 ä¸ª - å±•ç¤ºæ“ä½œæµç¨‹å’Œå†³ç­–é€»è¾‘
- **çŠ¶æ€å›¾ (State Diagram)**: 3 ä¸ª - å±•ç¤ºçŠ¶æ€è½¬æ¢
- **åºåˆ—å›¾ (Sequence)**: 2 ä¸ª - å±•ç¤ºç»„ä»¶äº¤äº’
- **æ—¶é—´çº¿ (Timeline)**: 2 ä¸ª - å±•ç¤ºæ—¶é—´åºåˆ—å˜åŒ–
- **å…³ç³»å›¾ (Graph)**: 15+ ä¸ª - å±•ç¤ºæ•°æ®ç»“æ„å…³ç³»
- **é¥¼å›¾ (Pie)**: 1 ä¸ª - å±•ç¤ºå æ¯”åˆ†æ
- **æ€ç»´å¯¼å›¾ (Mindmap)**: 1 ä¸ª - å±•ç¤ºè®¾è®¡åŸåˆ™
- **æ—…ç¨‹å›¾ (Journey)**: 1 ä¸ª - å±•ç¤ºå­¦ä¹ è·¯å¾„

**æ€»è®¡**: 30+ ä¸ªäº¤äº’å¼å›¾è¡¨ï¼Œå…¨é¢è¦†ç›– Uniswap V3 æ ¸å¿ƒæ•°æ®ç»“æ„çš„å„ä¸ªæ–¹é¢ï¼
